# å®é™…å¯è¡Œçš„ä»£ç æ¸…ç†æŠ¥å‘Š

**æ—¥æœŸ**: 2026-02-11
**çŠ¶æ€**: åŸºäºæ·±åº¦åˆ†æçš„ä¿®æ­£æŠ¥å‘Š

---

## ğŸ“Š æ‰§è¡Œæ‘˜è¦

ç»è¿‡æ·±åº¦ä»£ç åˆ†æï¼Œå‘ç°ä¹‹å‰çš„æ¸…ç†è®¡åˆ’è¿‡äºæ¿€è¿›ã€‚å®é™…æƒ…å†µæ˜¯ï¼š

- âœ… **å·²åˆ é™¤**: 2 ä¸ªæ–‡ä»¶ï¼ˆ200 è¡Œï¼‰
- âš ï¸ **å¤§éƒ¨åˆ†ä»£ç ä»åœ¨ä½¿ç”¨ä¸­**
- ğŸ”„ **éœ€è¦é‡æ–°è¯„ä¼°æ¸…ç†ç­–ç•¥**

---

## âœ… å·²å®Œæˆçš„æ¸…ç†

### 1. åˆ é™¤ pancake-sdk-utils.ts (100 è¡Œ)
- **çŠ¶æ€**: âœ… å·²åˆ é™¤
- **åŸå› **: å®Œå…¨æœªä½¿ç”¨ï¼Œ4ä¸ªå‡½æ•°æ— ä»»ä½•è°ƒç”¨
- **å½±å“**: æ— 

### 2. åˆ é™¤ cache-warmup.ts (100 è¡Œ)
- **çŠ¶æ€**: âœ… å·²åˆ é™¤
- **åŸå› **: å®Œå…¨æœªä½¿ç”¨ï¼Œç¼“å­˜é¢„çƒ­åŠŸèƒ½æœªå¯ç”¨
- **å½±å“**: æ— 

**æ€»è®¡å·²åˆ é™¤**: ~200 è¡Œ

---

## âŒ æ— æ³•åˆ é™¤çš„ä»£ç ï¼ˆåŸå› åˆ†æï¼‰

### 1. cache-manager.ts
**åŸè®¡åˆ’**: åˆ é™¤ï¼ˆè®¤ä¸ºæœªä½¿ç”¨ï¼‰
**å®é™…æƒ…å†µ**: âœ… **æ­£åœ¨ä½¿ç”¨**
- ä½¿ç”¨ä½ç½®: `background/index.ts` (L16, L573)
- ç”¨é€”: `tokenMetadataCache` - ç¼“å­˜ä»£å¸å…ƒæ•°æ®
- ä½¿ç”¨é¢‘ç‡: é«˜ï¼ˆåœ¨ `ensureTokenMetadata` ä¸­ä½¿ç”¨ï¼‰
- **ç»“è®º**: å¿…é¡»ä¿ç•™

### 2. retry-helper.ts
**åŸè®¡åˆ’**: åˆ é™¤ï¼ˆè®¤ä¸ºæœªä½¿ç”¨ï¼‰
**å®é™…æƒ…å†µ**: âœ… **æ­£åœ¨ä½¿ç”¨**
- ä½¿ç”¨ä½ç½®: `background/index.ts` (L15, L1962, L1964)
- ç”¨é€”: `retry()` å’Œ `isRpcError()` ç”¨äº RPC è°ƒç”¨é‡è¯•
- **ç»“è®º**: å¿…é¡»ä¿ç•™

### 3. retry.ts
**åŸè®¡åˆ’**: åˆ é™¤ï¼ˆè®¤ä¸ºä¸ retry-helper.ts é‡å¤ï¼‰
**å®é™…æƒ…å†µ**: âœ… **æ­£åœ¨ä½¿ç”¨**
- ä½¿ç”¨ä½ç½®: `route-query/query-executor.ts` (L9, L176)
- ç”¨é€”: `withRetry()` ç”¨äºè·¯ç”±æŸ¥è¯¢é‡è¯•
- **ç»“è®º**: å¿…é¡»ä¿ç•™ï¼ˆä¸¤å¥—é‡è¯•ç³»ç»ŸæœåŠ¡ä¸åŒæ¨¡å—ï¼‰

### 4. four-quote-bridge.ts
**åŸè®¡åˆ’**: åˆ é™¤å¤§é‡æ—§äº¤æ˜“é€»è¾‘ï¼ˆ~1000 è¡Œï¼‰
**å®é™…æƒ…å†µ**: âœ… **å¤§éƒ¨åˆ†å‡½æ•°ä»åœ¨ä½¿ç”¨**

| å‡½æ•°å | ä½¿ç”¨æƒ…å†µ | ç»“è®º |
|--------|---------|------|
| `prepareQuoteFunds` | four-quote-agent.ts, flap-quote-agent.ts | âœ… ä½¿ç”¨ä¸­ |
| `getQuoteBalance` | background/index.ts (L2123, L3223) | âœ… ä½¿ç”¨ä¸­ |
| `estimateQuoteToBnbAmount` | background/index.ts (L4103) | âœ… ä½¿ç”¨ä¸­ |
| `swapQuoteForBnb` | four-quote-agent.ts (L208) | âœ… ä½¿ç”¨ä¸­ |
| `quotePancakeV2Path` | custom-aggregator-agent.ts (L466, L525) | âœ… ä½¿ç”¨ä¸­ |
| `isBnbQuote` | å¤šå¤„ä½¿ç”¨ | âœ… ä½¿ç”¨ä¸­ |
| `resolveQuoteTokenName` | å¤šå¤„ä½¿ç”¨ | âœ… ä½¿ç”¨ä¸­ |
| `swapBnbForQuote` | æœªæ‰¾åˆ°ä½¿ç”¨ | â“ å¯èƒ½å¯åˆ é™¤ |
| `ensureQuoteAllowance` | æœªæ‰¾åˆ°ä½¿ç”¨ | â“ å¯èƒ½å¯åˆ é™¤ |
| `ensureTokenManagerQuoteApproval` | æœªæ‰¾åˆ°ä½¿ç”¨ | â“ å¯èƒ½å¯åˆ é™¤ |

**ç»“è®º**: åªæœ‰ 3 ä¸ªå‡½æ•°å¯èƒ½å¯ä»¥åˆ é™¤ï¼ˆçº¦ 200 è¡Œï¼‰

### 5. four-quote-agent.ts å’Œ flap-quote-agent.ts
**åŸè®¡åˆ’**: åˆ é™¤æ—§äº¤æ˜“é€»è¾‘
**å®é™…æƒ…å†µ**: âœ… **æ ¸å¿ƒåŠŸèƒ½ä»åœ¨ä½¿ç”¨**

**four-quote-agent.ts**:
- `shouldUseFourQuote()` - âœ… ä½¿ç”¨ä¸­ (L2871, L3139)
- `finalizeFourQuoteSell()` - âœ… ä½¿ç”¨ä¸­ (L3284)
- `requireFourQuoteToken()` - âœ… ä½¿ç”¨ä¸­ (L3222)
- `prepareFourQuoteBuy()` - âŒ æœªä½¿ç”¨ï¼ˆå¯åˆ é™¤ï¼‰

**flap-quote-agent.ts**:
- `shouldUseFlapQuote()` - âœ… ä½¿ç”¨ä¸­ (L2872)
- `prepareFlapQuoteBuy()` - âŒ æœªä½¿ç”¨ï¼ˆå¯åˆ é™¤ï¼‰

**ç»“è®º**: åªèƒ½åˆ é™¤ 2 ä¸ªæœªä½¿ç”¨çš„å‡½æ•°ï¼ˆçº¦ 100 è¡Œï¼‰

### 6. trading-channels-compat.ts
**åŸè®¡åˆ’**: åˆ é™¤ 600+ è¡Œå·²å¼ƒç”¨ä»£ç 
**å®é™…æƒ…å†µ**: âœ… **å¤§éƒ¨åˆ†å‡½æ•°ä»åœ¨ä½¿ç”¨**

| å‡½æ•°å | ä½¿ç”¨æƒ…å†µ | ç»“è®º |
|--------|---------|------|
| `getCachedAllowance` | background/index.ts (L2218, L2219) | âœ… ä½¿ç”¨ä¸­ |
| `clearAllowanceCache` | background/index.ts (L3619) | âœ… ä½¿ç”¨ä¸­ |
| `setPancakePreferredMode` | background/index.ts (L796, L798) | âœ… ä½¿ç”¨ä¸­ |
| `getPancakePreferredMode` | æœªæ‰¾åˆ°ä½¿ç”¨ | âŒ æœªä½¿ç”¨ |
| `setTokenTradeHint` | background/index.ts (L2314) | âœ… ä½¿ç”¨ä¸­ |
| `getTokenTradeHint` | background/index.ts (L2210) | âœ… ä½¿ç”¨ä¸­ |
| `prepareTokenSell` | custom-aggregator-agent.ts (L730) | âœ… ä½¿ç”¨ä¸­ |
| `checkRouteCache` | content/index.ts (L4026, L4039) | âœ… ä½¿ç”¨ä¸­ |
| `isRouteCacheExpiringSoon` | content/index.ts (L4027, L4040) | âœ… ä½¿ç”¨ä¸­ |

**ç»“è®º**: åªæœ‰ `getPancakePreferredMode` æœªä½¿ç”¨ï¼ˆçº¦ 5 è¡Œï¼‰

### 7. viem-helper.ts
**åŸè®¡åˆ’**: æ•´åˆåˆ° SDKClientManager
**å®é™…æƒ…å†µ**: âœ… **æ­£åœ¨ä½¿ç”¨**
- ä½¿ç”¨ä½ç½®: `background/index.ts` (L40-48)
- å¯¼å…¥å‡½æ•°: `buildChainConfig`, `createHttpClient`, `createNonceManager`, `createWallet` ç­‰
- **ç»“è®º**: å¿…é¡»ä¿ç•™ï¼ˆæ•´åˆå·¥ä½œé‡å¤§ï¼Œé£é™©é«˜ï¼‰

### 8. background/index.ts ä¸­çš„ SDK åˆ†æ”¯åˆ¤æ–­
**åŸè®¡åˆ’**: ç§»é™¤æ‰€æœ‰ `if (useSDK)` åˆ†æ”¯
**å®é™…æƒ…å†µ**: âœ… **SDK ä½œä¸ºä¸»è·¯å¾„ï¼Œæ—§ç³»ç»Ÿä½œä¸ºå›é€€**
- SDK å·²æˆä¸ºä¸»è¦äº¤æ˜“è·¯å¾„
- ä½†æ ‡å‡†é€šé“ä»ä½œä¸ºå›é€€æ–¹æ¡ˆ
- æ— æ³•å®Œå…¨ç§»é™¤åˆ†æ”¯åˆ¤æ–­
- **ç»“è®º**: å¿…é¡»ä¿ç•™ï¼ˆéœ€è¦å›é€€æ–¹æ¡ˆï¼‰

---

## ğŸ¯ å®é™…å¯åˆ é™¤çš„ä»£ç 

### å¯ä»¥å®‰å…¨åˆ é™¤çš„å†…å®¹

| é¡¹ç›® | ä½ç½® | è¡Œæ•° | éš¾åº¦ |
|------|------|------|------|
| âœ… pancake-sdk-utils.ts | src/shared/ | 100 | å·²åˆ é™¤ |
| âœ… cache-warmup.ts | src/shared/ | 100 | å·²åˆ é™¤ |
| âš ï¸ getPancakePreferredMode() | trading-channels-compat.ts | 5 | ç®€å• |
| âš ï¸ swapBnbForQuote() | four-quote-bridge.ts | 60 | ä¸­ç­‰ |
| âš ï¸ ensureQuoteAllowance() | four-quote-bridge.ts | 20 | ç®€å• |
| âš ï¸ ensureTokenManagerQuoteApproval() | four-quote-bridge.ts | 20 | ç®€å• |
| âš ï¸ prepareFourQuoteBuy() | four-quote-agent.ts | 50 | ç®€å• |
| âš ï¸ prepareFlapQuoteBuy() | flap-quote-agent.ts | 50 | ç®€å• |

**æ€»è®¡å¯åˆ é™¤**: ~405 è¡Œï¼ˆåŒ…æ‹¬å·²åˆ é™¤çš„ 200 è¡Œï¼‰

---

## ğŸ“ˆ ä¿®æ­£åçš„æ”¶ç›Š

### ä»£ç é‡å˜åŒ–
- **å·²åˆ é™¤**: 200 è¡Œï¼ˆ1.4%ï¼‰
- **å¯ç»§ç»­åˆ é™¤**: 205 è¡Œï¼ˆ1.4%ï¼‰
- **æ€»è®¡**: 405 è¡Œï¼ˆ2.8%ï¼‰

### ä¸åŸè®¡åˆ’å¯¹æ¯”
- **åŸè®¡åˆ’**: åˆ é™¤ 3200 è¡Œï¼ˆ22%ï¼‰
- **å®é™…å¯è¡Œ**: åˆ é™¤ 405 è¡Œï¼ˆ2.8%ï¼‰
- **å·®å¼‚**: åŸè®¡åˆ’è¿‡äºæ¿€è¿›ï¼Œå¤§éƒ¨åˆ†ä»£ç ä»åœ¨ä½¿ç”¨

---

## ğŸ” ä¸ºä»€ä¹ˆåŸè®¡åˆ’ä¸å¯è¡Œï¼Ÿ

### 1. è¯¯åˆ¤"æœªä½¿ç”¨"
- å¾ˆå¤šå‡½æ•°è™½ç„¶æ ‡è®°ä¸º `@deprecated`ï¼Œä½†ä»åœ¨ä½¿ç”¨
- å¯¼å…¥ä½†æœªç›´æ¥è°ƒç”¨çš„å‡½æ•°ï¼Œå¯èƒ½é€šè¿‡å…¶ä»–æ–¹å¼ä½¿ç”¨
- éœ€è¦æ›´æ·±å…¥çš„ä»£ç åˆ†æ

### 2. ä½ä¼°äº†å›é€€æœºåˆ¶çš„é‡è¦æ€§
- SDK è™½ç„¶æ˜¯ä¸»è·¯å¾„ï¼Œä½†æ—§ç³»ç»Ÿä½œä¸ºå›é€€æ–¹æ¡ˆä»ç„¶å¿…è¦
- Quote Bridge æœºåˆ¶ä»åœ¨ä½¿ç”¨
- ä¸èƒ½ç®€å•åœ°åˆ é™¤"æ—§"ä»£ç 

### 3. å¿½ç•¥äº†æ¨¡å—é—´çš„ä¾èµ–
- `retry.ts` å’Œ `retry-helper.ts` æœåŠ¡ä¸åŒæ¨¡å—
- `cache-manager.ts` è¢« background ä½¿ç”¨
- `viem-helper.ts` è¢«å¤šå¤„ä½¿ç”¨

---

## âœ… ç»§ç»­æ¸…ç†çš„å»ºè®®

### é˜¶æ®µ 1: åˆ é™¤ç¡®è®¤æœªä½¿ç”¨çš„å‡½æ•°ï¼ˆä½é£é™©ï¼‰

1. **åˆ é™¤ getPancakePreferredMode()** (5 è¡Œ)
   ```bash
   # åœ¨ trading-channels-compat.ts ä¸­åˆ é™¤ç¬¬ 273-275 è¡Œ
   ```

2. **åˆ é™¤ four-quote-bridge.ts ä¸­çš„ 3 ä¸ªå‡½æ•°** (100 è¡Œ)
   - `swapBnbForQuote()` (60 è¡Œ)
   - `ensureQuoteAllowance()` (20 è¡Œ)
   - `ensureTokenManagerQuoteApproval()` (20 è¡Œ)

3. **åˆ é™¤ prepareFourQuoteBuy() å’Œ prepareFlapQuoteBuy()** (100 è¡Œ)

**é¢„è®¡åˆ é™¤**: 205 è¡Œ
**é£é™©**: ä½
**æ—¶é—´**: 1-2 å°æ—¶

### é˜¶æ®µ 2: ä»£ç ä¼˜åŒ–ï¼ˆä¸­é£é™©ï¼‰

1. **ä¼˜åŒ– trading-channels-compat.ts**
   - å°†ç¼“å­˜é€»è¾‘è¿ç§»åˆ° route-query æ¨¡å—
   - ç®€åŒ–å…¼å®¹å±‚æ¥å£
   - é¢„è®¡ä¼˜åŒ–: 100-200 è¡Œ

2. **ä¼˜åŒ– background/index.ts**
   - ç®€åŒ– SDK åˆ†æ”¯åˆ¤æ–­é€»è¾‘
   - ç»Ÿä¸€é”™è¯¯å¤„ç†
   - é¢„è®¡ä¼˜åŒ–: 50-100 è¡Œ

**é¢„è®¡ä¼˜åŒ–**: 150-300 è¡Œ
**é£é™©**: ä¸­
**æ—¶é—´**: 2-3 å¤©

### é˜¶æ®µ 3: é•¿æœŸé‡æ„ï¼ˆé«˜é£é™©ï¼‰

1. **å®Œå…¨ç§»é™¤ Quote Bridge**
   - å¦‚æœç¡®è®¤ä¸å†éœ€è¦
   - å¯ä»¥åˆ é™¤ four-quote-agent.ts å’Œ flap-quote-agent.ts
   - é¢„è®¡åˆ é™¤: 500+ è¡Œ

2. **ç»Ÿä¸€å®¢æˆ·ç«¯ç®¡ç†**
   - å°† viem-helper.ts æ•´åˆåˆ° SDKClientManager
   - é¢„è®¡ä¼˜åŒ–: 200+ è¡Œ

**é¢„è®¡ä¼˜åŒ–**: 700+ è¡Œ
**é£é™©**: é«˜
**æ—¶é—´**: 1-2 å‘¨

---

## ğŸ¯ æ¨èæ‰§è¡Œæ–¹æ¡ˆ

### æ–¹æ¡ˆ A: ä¿å®ˆæ¸…ç†ï¼ˆæ¨èï¼‰
- åªæ‰§è¡Œé˜¶æ®µ 1
- åˆ é™¤ 205 è¡Œç¡®è®¤æœªä½¿ç”¨çš„ä»£ç 
- é£é™©ä½ï¼Œæ”¶ç›Šæ˜ç¡®
- æ—¶é—´: 1-2 å°æ—¶

### æ–¹æ¡ˆ B: é€‚åº¦ä¼˜åŒ–
- æ‰§è¡Œé˜¶æ®µ 1 + é˜¶æ®µ 2
- åˆ é™¤/ä¼˜åŒ– 355-505 è¡Œ
- é£é™©ä¸­ç­‰ï¼Œéœ€è¦å……åˆ†æµ‹è¯•
- æ—¶é—´: 2-4 å¤©

### æ–¹æ¡ˆ C: æ¿€è¿›é‡æ„
- æ‰§è¡Œæ‰€æœ‰é˜¶æ®µ
- åˆ é™¤/ä¼˜åŒ– 1055+ è¡Œ
- é£é™©é«˜ï¼Œéœ€è¦å¤§é‡æµ‹è¯•å’ŒéªŒè¯
- æ—¶é—´: 2-3 å‘¨

---

## ğŸ“ ç»éªŒæ•™è®­

### 1. ä»£ç åˆ†æéœ€è¦æ›´æ·±å…¥
- ä¸èƒ½åªçœ‹å¯¼å…¥ï¼Œè¦çœ‹å®é™…è°ƒç”¨
- æ ‡è®°ä¸º `@deprecated` ä¸ä»£è¡¨æœªä½¿ç”¨
- éœ€è¦å…¨å±€æœç´¢å’Œäº¤å‰éªŒè¯

### 2. å›é€€æœºåˆ¶å¾ˆé‡è¦
- ä¸èƒ½ç®€å•åˆ é™¤"æ—§"ä»£ç 
- éœ€è¦è¯„ä¼°å›é€€æ–¹æ¡ˆçš„å¿…è¦æ€§
- SDK è¿ç§»æ˜¯æ¸è¿›å¼çš„ï¼Œä¸æ˜¯ä¸€æ¬¡æ€§çš„

### 3. æ¨¡å—ä¾èµ–å¤æ‚
- éœ€è¦ç†è§£æ¨¡å—é—´çš„ä¾èµ–å…³ç³»
- ä¸èƒ½å­¤ç«‹åœ°çœ‹å•ä¸ªæ–‡ä»¶
- åˆ é™¤å‰éœ€è¦è¯„ä¼°å½±å“èŒƒå›´

---

## ğŸ‰ æ€»ç»“

**å®é™…æƒ…å†µ**:
- âœ… å·²åˆ é™¤ 200 è¡Œï¼ˆpancake-sdk-utils.ts, cache-warmup.tsï¼‰
- âš ï¸ å¯ç»§ç»­åˆ é™¤ 205 è¡Œï¼ˆæœªä½¿ç”¨çš„å‡½æ•°ï¼‰
- âŒ åŸè®¡åˆ’çš„ 3200 è¡Œä¸­ï¼Œå¤§éƒ¨åˆ†ä»åœ¨ä½¿ç”¨

**å»ºè®®**:
- é‡‡ç”¨æ–¹æ¡ˆ Aï¼ˆä¿å®ˆæ¸…ç†ï¼‰
- åˆ é™¤ç¡®è®¤æœªä½¿ç”¨çš„ 205 è¡Œä»£ç 
- æš‚ä¸è¿›è¡Œæ¿€è¿›çš„é‡æ„

**ä¸‹ä¸€æ­¥**:
1. åˆ é™¤ getPancakePreferredMode()
2. åˆ é™¤ four-quote-bridge.ts ä¸­çš„ 3 ä¸ªæœªä½¿ç”¨å‡½æ•°
3. åˆ é™¤ prepareFourQuoteBuy() å’Œ prepareFlapQuoteBuy()
4. è¿è¡Œæµ‹è¯•éªŒè¯
5. åˆ›å»ºæœ€ç»ˆæ¸…ç†æŠ¥å‘Š

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**: 2026-02-11 23:30
**åˆ†ææ–¹æ³•**: æ·±åº¦ä»£ç åˆ†æ + å…¨å±€æœç´¢éªŒè¯
**çŠ¶æ€**: å·²å®Œæˆ 200 è¡Œæ¸…ç†ï¼Œå¾…ç»§ç»­ 205 è¡Œ
