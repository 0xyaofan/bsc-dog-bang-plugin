# ä¹°å…¥æµç¨‹å¹¶å‘ä¼˜åŒ–æ–¹æ¡ˆ

**æ—¥æœŸï¼š** 2026-02-05
**é—®é¢˜ï¼š** è·¯ç”±æŸ¥è¯¢è€—æ—¶ 200ms+ï¼Œå½±å“äº¤æ˜“é€Ÿåº¦

---

## ğŸ” å½“å‰æµç¨‹åˆ†æ

### ä¹°å…¥æµç¨‹ï¼ˆä¸²è¡Œæ‰§è¡Œï¼‰

```
ç”¨æˆ·ç‚¹å‡»ä¹°å…¥
    â†“
æ­¥éª¤ 1: æŸ¥è¯¢æœ€ä½³è·¯ç”± (247ms)
    â”œâ”€ è¯»å–è·¯ç”±ç¼“å­˜
    â”œâ”€ è°ƒç”¨ getAmountsOut (200ms+)
    â””â”€ è¿”å›è·¯ç”±å’Œé‡‘é¢
    â†“
æ­¥éª¤ 2: å‘é€äº¤æ˜“ (781ms)
    â”œâ”€ åŒæ­¥é“¾ä¸Š nonce
    â”œâ”€ æ„å»ºäº¤æ˜“
    â”œâ”€ ç­¾å
    â””â”€ å‘é€åˆ°é“¾ä¸Š
    â†“
æ€»è€—æ—¶: 1030ms
```

### é—®é¢˜åˆ†æ

**ç“¶é¢ˆï¼š** æ­¥éª¤ 1 å’Œæ­¥éª¤ 2 æ˜¯ä¸²è¡Œçš„
- æ­¥éª¤ 1 å¿…é¡»å®Œæˆæ‰èƒ½å¼€å§‹æ­¥éª¤ 2
- ä½†å®é™…ä¸Šï¼Œ**nonce åŒæ­¥å¯ä»¥æå‰å¼€å§‹**

---

## ğŸ’¡ å¹¶å‘ä¼˜åŒ–æ–¹æ¡ˆ

### æ–¹æ¡ˆ 1ï¼šè·¯ç”±æŸ¥è¯¢ + Nonce åŒæ­¥å¹¶å‘ â­â­â­â­â­

**æ ¸å¿ƒæ€è·¯ï¼š** åœ¨æŸ¥è¯¢è·¯ç”±çš„åŒæ—¶ï¼Œæå‰åŒæ­¥ nonce

```typescript
// âŒ å½“å‰ï¼ˆä¸²è¡Œï¼‰
const routePlan = await findBestRoute(...);  // 247ms
const hash = await nonceExecutor(...);       // 781ms (åŒ…å« nonce åŒæ­¥)
// æ€»è€—æ—¶: 1028ms

// âœ… ä¼˜åŒ–åï¼ˆå¹¶å‘ï¼‰
const [routePlan, _] = await Promise.all([
  findBestRoute(...),                        // 247ms
  nonceExecutor.prefetchNonce()              // å¹¶å‘æ‰§è¡Œ
]);
const hash = await nonceExecutor(...);       // 781ms - nonceåŒæ­¥æ—¶é—´
// æ€»è€—æ—¶: çº¦ 800-900ms (èŠ‚çœ 100-200ms)
```

**ä¼˜ç‚¹ï¼š**
- âœ… èŠ‚çœ nonce åŒæ­¥æ—¶é—´ï¼ˆé€šå¸¸ 50-150msï¼‰
- âœ… ä¸å½±å“ä»·æ ¼å‡†ç¡®æ€§
- âœ… å®ç°ç®€å•
- âœ… æ— é£é™©

**å®æ–½éš¾åº¦ï¼š** ğŸŸ¢ ç®€å•

---

### æ–¹æ¡ˆ 2ï¼šé¢„çƒ­è·¯ç”±æŸ¥è¯¢ â­â­â­â­

**æ ¸å¿ƒæ€è·¯ï¼š** åœ¨ç”¨æˆ·è¾“å…¥é‡‘é¢æ—¶ï¼Œåå°é¢„å…ˆæŸ¥è¯¢è·¯ç”±

```typescript
// ç”¨æˆ·è¾“å…¥é‡‘é¢æ—¶è§¦å‘
onAmountChange(amount) {
  // åå°é¢„çƒ­æŸ¥è¯¢ï¼ˆä¸é˜»å¡ UIï¼‰
  this.prefetchRoute(amount);
}

// ç”¨æˆ·ç‚¹å‡»ä¹°å…¥æ—¶
async buy() {
  // ä¼˜å…ˆä½¿ç”¨é¢„çƒ­çš„ç»“æœ
  const routePlan = await this.getRouteWithPrefetch();
  // å¦‚æœé¢„çƒ­ç»“æœå¯ç”¨ï¼Œç«‹å³è¿”å›ï¼ˆ<10msï¼‰
  // å¦åˆ™ï¼Œæ­£å¸¸æŸ¥è¯¢ï¼ˆ247msï¼‰
}
```

**ä¼˜ç‚¹ï¼š**
- âœ… ç”¨æˆ·ç‚¹å‡»ä¹°å…¥æ—¶ï¼Œè·¯ç”±å¯èƒ½å·²ç»å‡†å¤‡å¥½
- âœ… å¤§å¹…å‡å°‘ç­‰å¾…æ—¶é—´ï¼ˆ247ms â†’ <10msï¼‰
- âœ… ä¸å½±å“ä»·æ ¼å‡†ç¡®æ€§ï¼ˆé¢„çƒ­æ—¶é—´å¾ˆçŸ­ï¼‰

**ç¼ºç‚¹ï¼š**
- âš ï¸ ç”¨æˆ·å¯èƒ½æ”¹å˜é‡‘é¢ï¼Œå¯¼è‡´é¢„çƒ­å¤±æ•ˆ
- âš ï¸ éœ€è¦å‰ç«¯é…åˆ

**å®æ–½éš¾åº¦ï¼š** ğŸŸ¡ ä¸­ç­‰

---

### æ–¹æ¡ˆ 3ï¼šæ™ºèƒ½é¢„åŠ è½½å¸¸ç”¨é‡‘é¢ â­â­â­

**æ ¸å¿ƒæ€è·¯ï¼š** åœ¨åå°é¢„å…ˆæŸ¥è¯¢å¸¸ç”¨é‡‘é¢çš„è·¯ç”±

```typescript
// é¡µé¢åŠ è½½æ—¶ï¼Œåå°é¢„åŠ è½½
async preloadCommonAmounts(tokenAddress) {
  const commonAmounts = [0.001, 0.01, 0.1]; // BNB

  // å¹¶å‘æŸ¥è¯¢æ‰€æœ‰å¸¸ç”¨é‡‘é¢
  await Promise.all(
    commonAmounts.map(amount =>
      this.prefetchRoute(tokenAddress, amount)
    )
  );
}

// ç”¨æˆ·ç‚¹å‡»ä¹°å…¥æ—¶
async buy(amount) {
  // å¦‚æœæ˜¯å¸¸ç”¨é‡‘é¢ï¼Œç«‹å³è¿”å›ç¼“å­˜
  const cached = this.getPreloadedRoute(amount);
  if (cached && !this.isStale(cached)) {
    return cached; // <1ms
  }

  // å¦åˆ™ï¼Œæ­£å¸¸æŸ¥è¯¢
  return await findBestRoute(...); // 247ms
}
```

**ä¼˜ç‚¹ï¼š**
- âœ… å¸¸ç”¨é‡‘é¢ç«‹å³è¿”å›ï¼ˆ<1msï¼‰
- âœ… è¦†ç›–å¤§éƒ¨åˆ†ç”¨æˆ·åœºæ™¯
- âœ… åå°é¢„åŠ è½½ï¼Œä¸å½±å“ç”¨æˆ·ä½“éªŒ

**ç¼ºç‚¹ï¼š**
- âš ï¸ Meme ä»£å¸ä»·æ ¼æ³¢åŠ¨å¤§ï¼Œç¼“å­˜å¯èƒ½è¿‡æ—¶
- âš ï¸ éœ€è¦å®šæœŸåˆ·æ–°ï¼ˆæ¯ 10-30 ç§’ï¼‰

**å®æ–½éš¾åº¦ï¼š** ğŸŸ¡ ä¸­ç­‰

---

## ğŸ¯ æ¨èå®æ–½æ–¹æ¡ˆ

### é˜¶æ®µ 1ï¼šç«‹å³å®æ–½ï¼ˆæœ€ç®€å•ï¼Œæœ€æœ‰æ•ˆï¼‰â­â­â­â­â­

**æ–¹æ¡ˆ 1ï¼šè·¯ç”±æŸ¥è¯¢ + Nonce åŒæ­¥å¹¶å‘**

**ä¿®æ”¹ä½ç½®ï¼š** `src/shared/trading-channels.ts` çš„ `buyPancake` å‡½æ•°

```typescript
// å½“å‰ä»£ç ï¼ˆç¬¬ 2641-2680 è¡Œï¼‰
async function buyPancake(...) {
  // æ­¥éª¤1: æŸ¥è¯¢æœ€ä½³è·¯ç”±
  const routePlan = await findBestRoute(...);

  // æ­¥éª¤2: å‘é€äº¤æ˜“
  const hash = await nonceExecutor('buy', (nonce) => sendSwap(nonce));
}

// ä¼˜åŒ–å
async function buyPancake(...) {
  // æ­¥éª¤1: å¹¶å‘æ‰§è¡Œè·¯ç”±æŸ¥è¯¢å’Œ nonce é¢„å–
  const routePromise = findBestRoute(...);
  const noncePromise = nonceExecutor?.prefetchNonce?.();

  const routePlan = await routePromise;
  if (noncePromise) await noncePromise;

  // æ­¥éª¤2: å‘é€äº¤æ˜“ï¼ˆnonce å·²é¢„å–ï¼Œæ›´å¿«ï¼‰
  const hash = await nonceExecutor('buy', (nonce) => sendSwap(nonce));
}
```

**é¢„æœŸæ•ˆæœï¼š**
- å½“å‰ï¼š247ms (è·¯ç”±) + 781ms (äº¤æ˜“) = 1028ms
- ä¼˜åŒ–åï¼š247ms (å¹¶å‘) + 650ms (äº¤æ˜“) = 897ms
- **èŠ‚çœï¼šçº¦ 130ms (13%)**

---

### é˜¶æ®µ 2ï¼šä¸­æœŸä¼˜åŒ–ï¼ˆéœ€è¦å‰ç«¯é…åˆï¼‰â­â­â­â­

**æ–¹æ¡ˆ 2ï¼šé¢„çƒ­è·¯ç”±æŸ¥è¯¢**

**å®æ–½æ­¥éª¤ï¼š**

1. **åç«¯æ·»åŠ é¢„çƒ­æ¥å£**
   ```typescript
   // src/shared/trading-channels.ts
   const routePrefetchCache = new Map();

   export async function prefetchRoute(tokenAddress, amount, slippage) {
     const key = `${tokenAddress}:${amount}:${slippage}`;
     const promise = findBestRoute(...);
     routePrefetchCache.set(key, {
       promise,
       timestamp: Date.now()
     });
     return promise;
   }

   export async function getRouteWithPrefetch(tokenAddress, amount, slippage) {
     const key = `${tokenAddress}:${amount}:${slippage}`;
     const cached = routePrefetchCache.get(key);

     // å¦‚æœé¢„çƒ­ç»“æœåœ¨ 5 ç§’å†…ï¼Œç›´æ¥ä½¿ç”¨
     if (cached && Date.now() - cached.timestamp < 5000) {
       return await cached.promise;
     }

     // å¦åˆ™ï¼Œæ­£å¸¸æŸ¥è¯¢
     return await findBestRoute(...);
   }
   ```

2. **å‰ç«¯è§¦å‘é¢„çƒ­**
   ```typescript
   // ç”¨æˆ·è¾“å…¥é‡‘é¢æ—¶
   onAmountChange(amount) {
     // å»¶è¿Ÿ 500ms åé¢„çƒ­ï¼ˆé¿å…é¢‘ç¹æŸ¥è¯¢ï¼‰
     clearTimeout(this.prefetchTimer);
     this.prefetchTimer = setTimeout(() => {
       chrome.runtime.sendMessage({
         action: 'prefetchRoute',
         tokenAddress: this.tokenAddress,
         amount: amount,
         slippage: this.slippage
       });
     }, 500);
   }
   ```

**é¢„æœŸæ•ˆæœï¼š**
- å¦‚æœé¢„çƒ­å‘½ä¸­ï¼š247ms â†’ <10ms
- **èŠ‚çœï¼šçº¦ 240ms (97%)**

---

### é˜¶æ®µ 3ï¼šé•¿æœŸä¼˜åŒ–ï¼ˆå¯é€‰ï¼‰â­â­â­

**æ–¹æ¡ˆ 3ï¼šæ™ºèƒ½é¢„åŠ è½½**

**å®æ–½è¦ç‚¹ï¼š**
- åœ¨ä»£å¸é¡µé¢åŠ è½½æ—¶ï¼Œåå°é¢„åŠ è½½å¸¸ç”¨é‡‘é¢
- æ¯ 15 ç§’åˆ·æ–°ä¸€æ¬¡ï¼ˆå¹³è¡¡å‡†ç¡®æ€§å’Œæ€§èƒ½ï¼‰
- ä»…é¢„åŠ è½½ 3-5 ä¸ªå¸¸ç”¨é‡‘é¢

---

## ğŸ“Š æ•ˆæœå¯¹æ¯”

| æ–¹æ¡ˆ | å®æ–½éš¾åº¦ | èŠ‚çœæ—¶é—´ | é£é™© | æ¨èåº¦ |
|------|---------|---------|------|--------|
| **æ–¹æ¡ˆ 1ï¼šå¹¶å‘ nonce** | ğŸŸ¢ ç®€å• | 130ms (13%) | ğŸŸ¢ æ—  | â­â­â­â­â­ |
| **æ–¹æ¡ˆ 2ï¼šé¢„çƒ­æŸ¥è¯¢** | ğŸŸ¡ ä¸­ç­‰ | 240ms (97%) | ğŸŸ¡ ä½ | â­â­â­â­ |
| **æ–¹æ¡ˆ 3ï¼šæ™ºèƒ½é¢„åŠ è½½** | ğŸŸ¡ ä¸­ç­‰ | 240ms (97%) | ğŸŸ  ä¸­ | â­â­â­ |

---

## ğŸš€ å®æ–½å»ºè®®

### ç«‹å³å®æ–½ï¼ˆä»Šå¤©ï¼‰

**æ–¹æ¡ˆ 1ï¼šè·¯ç”±æŸ¥è¯¢ + Nonce åŒæ­¥å¹¶å‘**
- ä¿®æ”¹ 3 ä¸ªå‡½æ•°ï¼š`buyPancake`, `sellPancake`, `buyFour`, `sellFour`
- é¢„è®¡æ—¶é—´ï¼š30 åˆ†é’Ÿ
- é¢„æœŸæ”¶ç›Šï¼šèŠ‚çœ 100-150ms

### æœ¬å‘¨å®æ–½ï¼ˆéœ€è¦å‰ç«¯é…åˆï¼‰

**æ–¹æ¡ˆ 2ï¼šé¢„çƒ­è·¯ç”±æŸ¥è¯¢**
- åç«¯æ·»åŠ é¢„çƒ­æ¥å£
- å‰ç«¯æ·»åŠ é¢„çƒ­è§¦å‘
- é¢„è®¡æ—¶é—´ï¼š2 å°æ—¶
- é¢„æœŸæ”¶ç›Šï¼šèŠ‚çœ 200-240msï¼ˆå‘½ä¸­æ—¶ï¼‰

---

## ğŸ’¡ å…¶ä»–ä¼˜åŒ–å»ºè®®

### 1. ä¼˜åŒ– RPC èŠ‚ç‚¹

**é—®é¢˜ï¼š** `getAmountsOut` è°ƒç”¨è€—æ—¶ 200ms+

**ä¼˜åŒ–ï¼š**
- ä½¿ç”¨æ›´å¿«çš„ RPC èŠ‚ç‚¹
- ä½¿ç”¨ WebSocket è¿æ¥ï¼ˆå‡å°‘æ¡æ‰‹æ—¶é—´ï¼‰
- ä½¿ç”¨æœ¬åœ°èŠ‚ç‚¹ï¼ˆå¦‚æœå¯èƒ½ï¼‰

**é¢„æœŸæ•ˆæœï¼š** 200ms â†’ 50-100ms

### 2. ä½¿ç”¨ Multicall

**é—®é¢˜ï¼š** å¤šä¸ªè·¯å¾„éœ€è¦å¤šæ¬¡ RPC è°ƒç”¨

**ä¼˜åŒ–ï¼š**
- ä½¿ç”¨ Multicall3 æ‰¹é‡æŸ¥è¯¢
- ä¸€æ¬¡è°ƒç”¨è·å–æ‰€æœ‰è·¯å¾„çš„è¾“å‡º

**é¢„æœŸæ•ˆæœï¼š** å‡å°‘ 50-100ms

---

## ğŸ“ æ€»ç»“

**æœ€ä½³æ–¹æ¡ˆï¼š** æ–¹æ¡ˆ 1 + æ–¹æ¡ˆ 2 ç»„åˆ

1. **ç«‹å³å®æ–½æ–¹æ¡ˆ 1**ï¼ˆå¹¶å‘ nonceï¼‰
   - ç®€å•ã€å®‰å…¨ã€ç«‹å³ç”Ÿæ•ˆ
   - èŠ‚çœ 100-150ms

2. **æœ¬å‘¨å®æ–½æ–¹æ¡ˆ 2**ï¼ˆé¢„çƒ­æŸ¥è¯¢ï¼‰
   - éœ€è¦å‰ç«¯é…åˆ
   - èŠ‚çœ 200-240msï¼ˆå‘½ä¸­æ—¶ï¼‰

**æ€»é¢„æœŸæ•ˆæœï¼š**
- å½“å‰ï¼š1030ms
- ä¼˜åŒ–åï¼š650-750msï¼ˆæ–¹æ¡ˆ 1ï¼‰æˆ– 400-500msï¼ˆæ–¹æ¡ˆ 1+2ï¼‰
- **æ€»èŠ‚çœï¼š30-60%**

---

**å»ºè®®ï¼š** å…ˆå®æ–½æ–¹æ¡ˆ 1ï¼ŒéªŒè¯æ•ˆæœåå†è€ƒè™‘æ–¹æ¡ˆ 2ã€‚
