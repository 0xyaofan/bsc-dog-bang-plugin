# æˆæƒæµç¨‹æµ‹è¯•æŒ‡å—

**ç‰ˆæœ¬ï¼š** v1.1.7+
**æ—¥æœŸï¼š** 2026-02-05

---

## ğŸ“‹ æµ‹è¯•ç›®æ ‡

éªŒè¯æˆæƒæµç¨‹çš„ä¸‰ä¸ªä¿®å¤ï¼š
1. âœ… æˆæƒçŠ¶æ€è·Ÿè¸ªæœºåˆ¶
2. âœ… äº¤æ˜“å‚æ•°éªŒè¯
3. âœ… prepareTokenSell ç¼“å­˜æŸ¥è¯¢

---

## ğŸ§ª æµ‹è¯•åœºæ™¯

### åœºæ™¯ 1: ä¹°å…¥æ—¶å¹¶å‘æˆæƒ + ç«‹å³å–å‡º

**ç›®çš„ï¼š** éªŒè¯æˆæƒçŠ¶æ€è·Ÿè¸ªå’Œç­‰å¾…æœºåˆ¶

**é…ç½®ï¼š**
- è‡ªåŠ¨æˆæƒæ¨¡å¼ï¼š**ä¹°å…¥æ—¶è‡ªåŠ¨æˆæƒ**

**æ­¥éª¤ï¼š**

1. é€‰æ‹©ä¸€ä¸ªæœªæˆæƒçš„ä»£å¸ï¼ˆæˆ–å…ˆæ’¤é”€æˆæƒï¼‰
2. ç‚¹å‡»ä¹°å…¥ï¼ˆä¾‹å¦‚ 0.01 BNBï¼‰
3. ä¹°å…¥äº¤æ˜“å‘é€åï¼Œ**ç«‹å³**ç‚¹å‡»å–å‡ºï¼ˆ100%ï¼‰
4. è§‚å¯Ÿæ—¥å¿—å’Œäº¤æ˜“ç»“æœ

**é¢„æœŸç»“æœï¼š**

```
[Dog Bang] å¼€å§‹è‡ªåŠ¨æˆæƒæ£€æŸ¥
[Approval Status] è®¾ç½®æˆæƒçŠ¶æ€: 0x...token_0x...spender -> pending
[ensureTokenApproval] æˆæƒäº¤æ˜“å·²å‘é€ï¼ˆä¸ç­‰å¾…ç¡®è®¤ï¼‰: 0x...hash
[Approval Status] è®¾ç½®æˆæƒçŠ¶æ€: 0x...token_0x...spender -> pending

// å–å‡ºæµç¨‹
[Pancake] æ£€æµ‹åˆ° V2 æˆæƒæ­£åœ¨è¿›è¡Œä¸­ï¼Œç­‰å¾…å®Œæˆ...
[Approval Status] ç­‰å¾…æˆæƒå®Œæˆ: 0x...token -> 0x...spender
[Approval Status] æˆæƒå·²å®Œæˆ
[Pancake] ä½¿ç”¨é¢„æŸ¥è¯¢çš„ V2 æˆæƒ: 115792089237316195423570985008687907853269984665640564039457584007913129639935
```

**éªŒè¯ç‚¹ï¼š**
- âœ… å–å‡ºæµç¨‹æ£€æµ‹åˆ°æˆæƒæ­£åœ¨è¿›è¡Œä¸­
- âœ… å–å‡ºç­‰å¾…æˆæƒå®Œæˆï¼ˆä¸ä¼šç«‹å³å¤±è´¥ï¼‰
- âœ… æˆæƒå®Œæˆåå–å‡ºäº¤æ˜“æˆåŠŸå‘é€
- âœ… ä¸ä¼šå‡ºç°"æˆæƒä¸è¶³"é”™è¯¯

---

### åœºæ™¯ 2: åˆ‡æ¢é¡µé¢æ—¶è‡ªåŠ¨æˆæƒ

**ç›®çš„ï¼š** éªŒè¯é¡µé¢åˆ‡æ¢æ—¶çš„æˆæƒé€»è¾‘

**é…ç½®ï¼š**
- è‡ªåŠ¨æˆæƒæ¨¡å¼ï¼š**åˆ‡æ¢é¡µé¢æ—¶è‡ªåŠ¨æˆæƒ**

**æ­¥éª¤ï¼š**

1. é€‰æ‹©ä¸€ä¸ªæœªæˆæƒçš„ä»£å¸
2. åˆ‡æ¢åˆ°è¯¥ä»£å¸çš„äº¤æ˜“é¡µé¢
3. ç­‰å¾… 1-2 ç§’
4. è§‚å¯ŸæˆæƒçŠ¶æ€æ˜¾ç¤º

**é¢„æœŸç»“æœï¼š**

```
[Dog Bang] Auto approve mode: switch
[Dog Bang] æ‰§è¡Œåˆ‡æ¢æ—¶è‡ªåŠ¨æˆæƒ: { tokenAddress: '0x...', channel: 'pancake' }
[Approval Status] è®¾ç½®æˆæƒçŠ¶æ€: 0x...token_0x...spender -> pending
[ensureTokenApproval] æˆæƒäº¤æ˜“å·²å‘é€ï¼ˆä¸ç­‰å¾…ç¡®è®¤ï¼‰: 0x...hash
[Dog Bang] è‡ªåŠ¨æˆæƒæˆåŠŸ
```

**éªŒè¯ç‚¹ï¼š**
- âœ… é¡µé¢åˆ‡æ¢åè‡ªåŠ¨è§¦å‘æˆæƒ
- âœ… æˆæƒçŠ¶æ€æ­£ç¡®æ˜¾ç¤º
- âœ… 1.5 ç§’åæŸ¥è¯¢é“¾ä¸ŠæˆæƒçŠ¶æ€

---

### åœºæ™¯ 3: é¦–æ¬¡å–å‡ºæ—¶è‡ªåŠ¨æˆæƒ

**ç›®çš„ï¼š** éªŒè¯é¦–æ¬¡å–å‡ºçš„æˆæƒé€»è¾‘

**é…ç½®ï¼š**
- è‡ªåŠ¨æˆæƒæ¨¡å¼ï¼š**é¦–æ¬¡å–å‡ºæ—¶è‡ªåŠ¨æˆæƒ**

**æ­¥éª¤ï¼š**

1. é€‰æ‹©ä¸€ä¸ªæœªæˆæƒçš„ä»£å¸ï¼ˆç¡®ä¿æœ‰ä½™é¢ï¼‰
2. ç›´æ¥ç‚¹å‡»å–å‡ºï¼ˆä¸è¦å…ˆä¹°å…¥ï¼‰
3. è§‚å¯Ÿæˆæƒæµç¨‹

**é¢„æœŸç»“æœï¼š**

```
[Dog Bang] å¼€å§‹è‡ªåŠ¨æˆæƒæ£€æŸ¥
[Approval Status] è®¾ç½®æˆæƒçŠ¶æ€: 0x...token_0x...spender -> pending
[ensureTokenApproval] æˆæƒäº¤æ˜“å·²å‘é€ï¼ˆä¸ç­‰å¾…ç¡®è®¤ï¼‰: 0x...hash

// å–å‡ºæµç¨‹ç»§ç»­
[Pancake] ä½¿ç”¨é¢„æŸ¥è¯¢çš„ V2 æˆæƒ: 115792089237316195423570985008687907853269984665640564039457584007913129639935
```

**éªŒè¯ç‚¹ï¼š**
- âœ… é¦–æ¬¡å–å‡ºè§¦å‘æˆæƒ
- âœ… æˆæƒå’Œå–å‡ºä½¿ç”¨ nonce æœºåˆ¶é¡ºåºæ‰§è¡Œ
- âœ… ç¬¬äºŒæ¬¡å–å‡ºä¸å†è§¦å‘æˆæƒï¼ˆç¼“å­˜å‘½ä¸­ï¼‰

---

### åœºæ™¯ 4: prepareTokenSell ç¼“å­˜å‘½ä¸­

**ç›®çš„ï¼š** éªŒè¯ç¼“å­˜æŸ¥è¯¢ä¿®å¤

**æ­¥éª¤ï¼š**

1. åˆ‡æ¢åˆ°ä»£å¸äº¤æ˜“é¡µé¢ï¼ˆè§¦å‘ tokenInfo ç¼“å­˜ï¼‰
2. ç­‰å¾…ç¼“å­˜åŠ è½½å®Œæˆï¼ˆçº¦ 1 ç§’ï¼‰
3. ç‚¹å‡»å–å‡º
4. è§‚å¯Ÿæ—¥å¿—

**é¢„æœŸç»“æœï¼š**

```
// é¡µé¢åˆ‡æ¢æ—¶ç¼“å­˜ä»£å¸ä¿¡æ¯
[Background] é¢„åŠ è½½ä»£å¸ä¿¡æ¯: 0x...

// å–å‡ºæ—¶ä½¿ç”¨ç¼“å­˜
[prepareTokenSell] ä½¿ç”¨ç¼“å­˜çš„ä»£å¸ä¿¡æ¯ (pancake)
```

**éªŒè¯ç‚¹ï¼š**
- âœ… æ—¥å¿—æ˜¾ç¤º"ä½¿ç”¨ç¼“å­˜çš„ä»£å¸ä¿¡æ¯ (pancake)"
- âœ… **ä¸ä¼š**å‡ºç°"ç¼“å­˜ä¸å¯ç”¨ï¼Œé‡æ–°æŸ¥è¯¢ä»£å¸ä¿¡æ¯"
- âœ… å–å‡ºé€Ÿåº¦æ˜æ˜¾æå‡ï¼ˆå‡å°‘é“¾ä¸ŠæŸ¥è¯¢ï¼‰

---

### åœºæ™¯ 5: è·¯ç”±æŸ¥è¯¢å¤±è´¥çš„å‚æ•°éªŒè¯

**ç›®çš„ï¼š** éªŒè¯å‚æ•°éªŒè¯æœºåˆ¶

**æ­¥éª¤ï¼š**

1. é€‰æ‹©ä¸€ä¸ªæµåŠ¨æ€§æä½æˆ–æ²¡æœ‰æµåŠ¨æ€§çš„ä»£å¸
2. å°è¯•å–å‡º
3. è§‚å¯Ÿé”™è¯¯ä¿¡æ¯

**é¢„æœŸç»“æœï¼ˆä¿®å¤å‰ï¼‰ï¼š**

```
âŒ å–å‡ºå¤±è´¥: [Channel] sendTransaction å¤±è´¥ (sellToken)ï¼Œä½¿ç”¨ fallback gas é‡æ–°å°è¯•: Missing or invalid parameters.
```

**é¢„æœŸç»“æœï¼ˆä¿®å¤åï¼‰ï¼š**

```
âŒ å–å‡ºå¤±è´¥: è·¯ç”±æŸ¥è¯¢å¤±è´¥ï¼Œæ— æ³•è·å–æœ‰æ•ˆè·¯å¾„
```

æˆ–

```
âŒ å–å‡ºå¤±è´¥: æ— æ•ˆçš„ V2 äº¤æ˜“è·¯å¾„: []
```

**éªŒè¯ç‚¹ï¼š**
- âœ… é”™è¯¯ä¿¡æ¯æ›´æ˜ç¡®ï¼ŒæŒ‡å‡ºå…·ä½“é—®é¢˜
- âœ… ä¸ä¼šå‡ºç°æ¨¡ç³Šçš„ "Missing or invalid parameters"
- âœ… åœ¨å‚æ•°éªŒè¯é˜¶æ®µå°±æ•è·é”™è¯¯ï¼Œä¸ä¼šåˆ° sendTransaction

---

### åœºæ™¯ 6: æˆæƒå¤±è´¥å¤„ç†

**ç›®çš„ï¼š** éªŒè¯æˆæƒå¤±è´¥æ—¶çš„çŠ¶æ€æ›´æ–°

**æ­¥éª¤ï¼š**

1. è®¾ç½®æä½çš„ Gas Priceï¼ˆä¾‹å¦‚ 1 Gweiï¼‰
2. å°è¯•æˆæƒï¼ˆå¯èƒ½å›  Gas ä¸è¶³è€Œå¤±è´¥ï¼‰
3. è§‚å¯ŸæˆæƒçŠ¶æ€

**é¢„æœŸç»“æœï¼š**

```
[Approval Status] è®¾ç½®æˆæƒçŠ¶æ€: 0x...token_0x...spender -> pending
[ensureTokenApproval] æˆæƒäº¤æ˜“å‘é€å¤±è´¥: ...
[Approval Status] è®¾ç½®æˆæƒçŠ¶æ€: 0x...token_0x...spender -> failed
```

**éªŒè¯ç‚¹ï¼š**
- âœ… æˆæƒå¤±è´¥æ—¶çŠ¶æ€æ›´æ–°ä¸º `failed`
- âœ… åç»­å–å‡ºä¸ä¼šç­‰å¾…å¤±è´¥çš„æˆæƒ
- âœ… ç”¨æˆ·å¯ä»¥é‡æ–°å°è¯•æˆæƒ

---

## ğŸ” è°ƒè¯•å·¥å…·

### 1. æŸ¥çœ‹æˆæƒçŠ¶æ€ç¼“å­˜

åœ¨æµè§ˆå™¨æ§åˆ¶å°æ‰§è¡Œï¼š

```javascript
// å‘é€æ¶ˆæ¯åˆ° background
chrome.runtime.sendMessage({
  action: 'get_cache_info',
  data: { tokenAddress: '0x...' }
}, (response) => {
  console.log('=== Cache Info ===');
  console.log('Route:', response.cache?.route);
  console.log('Allowances:', response.cache?.allowances);
});
```

### 2. æ‰‹åŠ¨æ¸…é™¤æˆæƒçŠ¶æ€

```javascript
// åœ¨ background console ä¸­æ‰§è¡Œ
import { clearApprovalStatus } from './shared/trading-channels.js';

clearApprovalStatus(
  '0x...tokenAddress',
  '0x...spenderAddress'
);
```

### 3. æŸ¥çœ‹æˆæƒçŠ¶æ€

```javascript
// åœ¨ background console ä¸­æ‰§è¡Œ
import { getApprovalStatus } from './shared/trading-channels.js';

const status = getApprovalStatus(
  '0x...tokenAddress',
  '0x...spenderAddress'
);

console.log('Approval Status:', status);
// è¾“å‡º: { allowance: 115792...n, status: 'pending', txHash: '0x...', updatedAt: 1738742400000 }
```

---

## ğŸ“Š æ€§èƒ½å¯¹æ¯”

### ä¿®å¤å‰

| æ“ä½œ | è€—æ—¶ | è¯´æ˜ |
|------|------|------|
| ä¹°å…¥ + ç«‹å³å–å‡º | å¤±è´¥ | æˆæƒæœªå®Œæˆï¼Œå–å‡ºå¤±è´¥ |
| prepareTokenSell | 200-300ms | æ¯æ¬¡éƒ½æŸ¥è¯¢é“¾ä¸Š |
| å‚æ•°é”™è¯¯ | æ¨¡ç³Š | "Missing or invalid parameters" |

### ä¿®å¤å

| æ“ä½œ | è€—æ—¶ | è¯´æ˜ |
|------|------|------|
| ä¹°å…¥ + ç«‹å³å–å‡º | æˆåŠŸ | ç­‰å¾…æˆæƒå®Œæˆï¼ˆæœ€å¤š30ç§’ï¼‰ |
| prepareTokenSell | <10ms | ä½¿ç”¨ç¼“å­˜ |
| å‚æ•°é”™è¯¯ | æ˜ç¡® | "æ— æ•ˆçš„ V2 äº¤æ˜“è·¯å¾„: []" |

---

## âœ… æµ‹è¯•æ£€æŸ¥æ¸…å•

- [ ] åœºæ™¯ 1: ä¹°å…¥æ—¶å¹¶å‘æˆæƒ + ç«‹å³å–å‡º
- [ ] åœºæ™¯ 2: åˆ‡æ¢é¡µé¢æ—¶è‡ªåŠ¨æˆæƒ
- [ ] åœºæ™¯ 3: é¦–æ¬¡å–å‡ºæ—¶è‡ªåŠ¨æˆæƒ
- [ ] åœºæ™¯ 4: prepareTokenSell ç¼“å­˜å‘½ä¸­
- [ ] åœºæ™¯ 5: è·¯ç”±æŸ¥è¯¢å¤±è´¥çš„å‚æ•°éªŒè¯
- [ ] åœºæ™¯ 6: æˆæƒå¤±è´¥å¤„ç†

---

## ğŸ› å·²çŸ¥é—®é¢˜

### 1. æˆæƒçŠ¶æ€ä¸æŒä¹…åŒ–

**é—®é¢˜ï¼š** åˆ·æ–°é¡µé¢åæˆæƒçŠ¶æ€ç¼“å­˜ä¸¢å¤±

**å½±å“ï¼š** å¦‚æœæˆæƒäº¤æ˜“è¿˜åœ¨ pendingï¼Œåˆ·æ–°é¡µé¢åä¼šä¸¢å¤±çŠ¶æ€

**è§£å†³æ–¹æ¡ˆï¼š** å‚è€ƒæ–‡æ¡£ä¸­çš„"æŒä¹…åŒ–æˆæƒçŠ¶æ€ç¼“å­˜"å»ºè®®

### 2. æˆæƒäº¤æ˜“ç¡®è®¤æœªç›‘å¬

**é—®é¢˜ï¼š** æˆæƒäº¤æ˜“å‘é€åï¼ŒçŠ¶æ€ä¸€ç›´æ˜¯ `pending`ï¼Œæ²¡æœ‰æ›´æ–°ä¸º `success`

**å½±å“ï¼š** ä¾èµ–ä¹è§‚æ›´æ–° + nonce æœºåˆ¶ï¼Œå®é™…ä¸Šä¸å½±å“äº¤æ˜“

**è§£å†³æ–¹æ¡ˆï¼š** å‚è€ƒæ–‡æ¡£ä¸­çš„"ç›‘å¬æˆæƒäº¤æ˜“ç¡®è®¤"å»ºè®®

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [æˆæƒæµç¨‹é—®é¢˜åˆ†ææŠ¥å‘Š](./authorization-flow-issues-analysis.md)
- [è·¯ç”±ä¼˜åŒ–å¼€å‘æ‰‹å†Œ](./route-optimization-guide.md)
- [ç¼“å­˜è°ƒè¯•æŒ‡å—](./cache-debugging-guide.md)
