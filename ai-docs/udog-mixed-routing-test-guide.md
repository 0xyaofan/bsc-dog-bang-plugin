# UDOG 混合路由测试指南

## 测试概述

本文档提供 UDOG (0xcc411e6eac8f660972bf06ac5ea12058267755f0) 混合 V2/V3 路由功能的测试指南。

## 路由信息

### 代币地址
- **WBNB**: `0xbb4CdB9CBd36B01bD1cBaEBF2De08d9173bc095c`
- **USAT** (桥接代币): `0xdB7A6D5A127Ea5C0A3576677112F13d731232A27`
- **UDOG** (目标代币): `0xCc411E6eAc8f660972bf06ac5Ea12058267755f0`

### 路由路径
```
买入: WBNB → USAT (V3, 1% fee) → UDOG (V2)
       ↓                           ↓
   第一步交易                   第二步交易
```

### 池地址
- **WBNB-USAT V3 Pool**: `0x56A6a12D664a16654571e6E1E8c5FCe4131e7059` (1% fee)
- **USAT-UDOG V2 Pair**: `0x51C5d5F9d135fe709A899b7473b2793A9AE24D4A`

## 测试前准备

### 1. 构建项目
```bash
npm run build
```

### 2. 加载扩展
1. 打开 Chrome 浏览器
2. 访问 `chrome://extensions/`
3. 启用"开发者模式"
4. 点击"加载已解压的扩展程序"
5. 选择项目的 `extension` 目录

### 3. 准备测试钱包
- 确保钱包有足够的 BNB 用于测试（建议至少 0.01 BNB）
- 建议使用测试钱包，不要使用主钱包

## 测试步骤

### 测试 1: 验证混合路由检测

1. 访问 UDOG 代币页面（例如 gmgn.ai 或 four.meme）
2. 打开浏览器控制台（F12）
3. 观察日志输出，应该看到类似信息：
   ```
   [PancakeSwap] 检测到混合 V2/V3 路由: V3 → V2 (WBNB → 0xdB7A...2A27 → 0xCc41...55f0)
   ```

### 测试 2: 执行买入交易（小额测试）

**⚠️ 重要提示**:
- 首次测试建议使用非常小的金额（如 0.001 BNB）
- 混合路由需要执行两步交易，Gas 费用会比普通交易高
- 确保钱包有足够的 BNB 支付两次交易的 Gas 费

**步骤**:

1. 在插件界面输入买入金额（建议 0.001 BNB）
2. 设置滑点（建议 5-10%，因为涉及两步交易）
3. 点击"买入"按钮
4. 观察交易流程：

   **第一步交易（V3 Swap）**:
   - 控制台应显示: `[PancakeSwap] 执行混合 V2/V3 路由交易: V3 → V2...`
   - 控制台应显示: `[PancakeSwap] 第一步：V3 swap 0xbb4C → 0xdB7A`
   - 控制台应显示: `[PancakeSwap] V3 交易已发送: 0x...`
   - 等待交易确认（通常 3-5 秒）
   - 控制台应显示: `[PancakeSwap] ✅ V3 交易确认成功`

   **第二步交易（V2 Swap）**:
   - 控制台应显示: `[PancakeSwap] 获得桥接代币: ...`
   - 控制台应显示: `[PancakeSwap] 第二步：V2 swap 0xdB7A → 0xCc41`
   - 如果需要授权，会先执行授权交易
   - 控制台应显示: `[PancakeSwap] V2 交易已发送: 0x...`
   - 控制台应显示: `[PancakeSwap] ✅ 混合路由交易完成`

5. 验证结果：
   - 检查钱包中是否收到 UDOG 代币
   - 在 BSCScan 上查看两笔交易记录
   - 确认两笔交易都成功

### 测试 3: 验证卖出提示

1. 持有 UDOG 代币后，尝试卖出
2. 应该看到错误提示：
   ```
   [PancakeSwap] 卖出暂不支持混合 V2/V3 路由，请使用 PancakeSwap 官网进行交易
   ```
3. 这是预期行为，卖出功能暂未实现

## 预期行为

### ✅ 成功场景

1. **检测成功**: 系统正确识别 UDOG 需要混合路由
2. **第一步成功**: V3 swap 成功执行，获得 USAT
3. **授权成功**: USAT 成功授权给 V2 Router（如果需要）
4. **第二步成功**: V2 swap 成功执行，获得 UDOG
5. **余额更新**: 钱包余额正确显示 UDOG 数量

### ❌ 可能的错误场景

1. **Gas 不足**:
   - 错误信息: "insufficient funds for gas"
   - 解决方案: 确保钱包有足够的 BNB

2. **第一步交易失败**:
   - 错误信息: "V3 交易失败"
   - 可能原因: 滑点设置过低、流动性不足
   - 解决方案: 增加滑点或减少交易金额

3. **第二步交易失败**:
   - 错误信息: 第二步交易 revert
   - 可能原因: 第一步获得的 USAT 数量不足以完成第二步
   - 解决方案: 增加滑点设置

4. **授权失败**:
   - 错误信息: "授权交易失败"
   - 解决方案: 检查 Gas 设置，重试

## 调试技巧

### 1. 查看详细日志
打开浏览器控制台，筛选 `[PancakeSwap]` 日志查看详细执行流程

### 2. 查看链上交易
在 BSCScan 上查看交易详情：
- 第一步交易应该调用 PancakeSwap V3 SmartRouter 的 `exactInputSingle`
- 第二步交易应该调用 PancakeSwap V2 Router 的 `swapExactTokensForTokens`

### 3. 验证池地址
使用测试脚本验证池地址：
```bash
node scripts/test-udog-mixed-routing.js
```

### 4. 检查授权状态
在控制台执行：
```javascript
// 查看 USAT 对 V2 Router 的授权
// (需要在页面上下文中执行)
```

## 性能指标

### 预期交易时间
- **第一步 (V3)**: 3-5 秒（等待确认）
- **授权 (如需要)**: 3-5 秒
- **第二步 (V2)**: 3-5 秒
- **总计**: 约 10-15 秒（首次交易）或 6-10 秒（已授权）

### Gas 费用
- **第一步 (V3)**: 约 150,000-200,000 gas
- **授权**: 约 50,000 gas（如需要）
- **第二步 (V2)**: 约 120,000-150,000 gas
- **总计**: 约 270,000-400,000 gas

## 故障排除

### 问题 1: 交易一直卡在第一步
**症状**: V3 交易发送后长时间未确认

**可能原因**:
- Gas 价格设置过低
- 网络拥堵

**解决方案**:
- 在 BSCScan 上检查交易状态
- 如果交易 pending，等待或加速交易
- 如果交易失败，检查失败原因

### 问题 2: 第二步交易失败
**症状**: 第一步成功，第二步 revert

**可能原因**:
- 第一步获得的 USAT 数量不足
- V2 池流动性不足
- 滑点设置过低

**解决方案**:
- 增加滑点设置到 10-15%
- 减少交易金额
- 检查 V2 池流动性

### 问题 3: 授权失败
**症状**: 授权交易 revert

**可能原因**:
- Gas 设置问题
- 代币合约问题

**解决方案**:
- 检查 Gas 设置
- 尝试手动在 BSCScan 上授权

## 测试检查清单

- [ ] 项目构建成功
- [ ] 扩展加载成功
- [ ] 钱包连接成功
- [ ] 混合路由检测成功
- [ ] 第一步 V3 交易成功
- [ ] USAT 授权成功（如需要）
- [ ] 第二步 V2 交易成功
- [ ] 收到 UDOG 代币
- [ ] 余额显示正确
- [ ] 卖出提示正确显示

## 参考链接

- **UDOG 合约**: https://bscscan.com/address/0xcc411e6eac8f660972bf06ac5ea12058267755f0
- **USAT 合约**: https://bscscan.com/address/0xdb7a6d5a127ea5c0a3576677112f13d731232a27
- **WBNB-USAT V3 Pool**: https://bscscan.com/address/0x56A6a12D664a16654571e6E1E8c5FCe4131e7059
- **USAT-UDOG V2 Pair**: https://bscscan.com/address/0x51C5d5F9d135fe709A899b7473b2793A9AE24D4A
- **PancakeSwap V3 SmartRouter**: https://bscscan.com/address/0x13f4EA83D0bd40E75C8222255bc855a974568Dd4
- **PancakeSwap V2 Router**: https://bscscan.com/address/0x10ED43C718714eb63d5aA57B78B54704E256024E

## 报告问题

如果测试过程中遇到问题，请提供以下信息：
1. 错误信息（控制台日志）
2. 交易哈希（如果有）
3. 测试金额和滑点设置
4. 浏览器和扩展版本
5. 复现步骤
