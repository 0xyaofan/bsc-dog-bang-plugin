# 架构决策记录 (Architecture Decision Records)

本目录包含了 BSC 打狗棒项目的所有重要架构决策记录。

## 什么是 ADR？

架构决策记录（Architecture Decision Record，ADR）是一种记录软件架构决策的文档格式。每个 ADR 描述了一个具体的架构决策，包括：
- 决策的背景和问题
- 考虑过的方案
- 最终选择的方案和理由
- 决策的后果和影响

## ADR 列表

### [ADR-001: Service Worker 环境下的路由查询策略](./001-service-worker-routing-strategy.md)
**状态**: 已接受
**日期**: 2026-02-08
**摘要**: 在 Chrome Extension Service Worker 环境中，`import()` 被禁用导致 viem 库无法正常工作。采用错误捕获 + 特殊配对映射的混合策略来解决这个问题。

**关键决策**:
- 捕获 Service Worker 错误并提供回退策略
- 维护特殊代币对的硬编码映射
- 根据平台特性做出合理假设

**影响**:
- ✅ 快速解决了 Service Worker 限制
- ⚠️ 需要手动维护特殊配对映射

---

### [ADR-002: 路由缓存策略](./002-route-caching-strategy.md)
**状态**: 已接受
**日期**: 2026-02-08
**摘要**: 采用分层缓存策略，根据代币迁移状态使用不同的缓存时长。已迁移代币永久缓存，未迁移代币每次重新查询。

**关键决策**:
- 已迁移代币：永久缓存
- 未迁移代币：每次重新查询
- 自动清理过期缓存

**影响**:
- ✅ 显著减少链上查询次数
- ✅ 提升响应速度
- ⚠️ 内存占用增加（但可控）

---

### [ADR-003: 平台检测机制](./003-platform-detection-mechanism.md)
**状态**: 已接受
**日期**: 2026-02-08
**摘要**: 采用基于地址模式的静态检测机制，通过代币地址的特征（前缀/后缀）快速识别所属平台。

**关键决策**:
- Four.meme: 地址以 `ffff` 或 `4444` 结尾
- XMode: 地址以 `0x4444` 开头
- Flap: 地址以 `7777` 或 `8888` 结尾
- Luna: 没有特定模式，归类为 unknown

**影响**:
- ✅ 极快的检测速度（< 1ms）
- ✅ 无需链上查询
- ⚠️ 依赖平台的地址生成规则

---

## ADR 编写指南

### 何时创建 ADR？

当你需要做出以下类型的决策时，应该创建 ADR：
- 影响系统架构的重要技术决策
- 有多个可行方案需要权衡的决策
- 可能影响未来开发的决策
- 需要向团队解释的复杂决策

### ADR 模板

```markdown
# ADR-XXX: 决策标题

## 状态
[提议中 | 已接受 | 已废弃 | 已替代]

## 日期
YYYY-MM-DD

## 背景
描述需要做出决策的背景和问题

## 决策
描述最终选择的方案

## 理由
解释为什么选择这个方案

### 考虑过的其他方案
列出并分析其他备选方案

## 后果
描述这个决策的影响（正面和负面）

## 相关决策
链接到相关的 ADR

## 参考资料
相关文档和资源链接
```

### ADR 编号规则

- 使用三位数字编号：001, 002, 003, ...
- 按时间顺序递增
- 不要重用已废弃的编号

### ADR 状态

- **提议中 (Proposed)**: 正在讨论中
- **已接受 (Accepted)**: 已经采纳并实施
- **已废弃 (Deprecated)**: 不再使用，但保留记录
- **已替代 (Superseded)**: 被新的 ADR 替代

## 相关文档

- [路由系统重构方案](../routing-system-refactoring-plan.md)
- [路由系统短期改进](../routing-system-short-term-improvements.md)
- [如何避免跨平台影响](../how-to-avoid-cross-platform-impact.md)

## 参考资料

- [ADR 最佳实践](https://adr.github.io/)
- [为什么要写 ADR](https://cognitect.com/blog/2011/11/15/documenting-architecture-decisions)
