# äº¤æ˜“æ€§èƒ½ä¼˜åŒ–å¼€å‘æ‰§è¡Œè®¡åˆ’

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

**ç›®æ ‡**ï¼šä¼˜åŒ–æœªè¿ç§»ä»£å¸é¦–æ¬¡äº¤æ˜“æ€§èƒ½ï¼Œä» 3+ ç§’é™è‡³ 1 ç§’ä»¥å†…

**æ ¸å¿ƒä¼˜åŒ–ç­–ç•¥**ï¼š
1. **æ°¸ä¹…ç¼“å­˜ç­–ç•¥**ï¼šæœªè¿ç§»å’Œå·²è¿ç§»ä»£å¸éƒ½ä½¿ç”¨æ°¸ä¹…ç¼“å­˜ï¼Œåªåœ¨è¿ç§»çŠ¶æ€å˜åŒ–æ—¶æ›´æ–°
2. **å¤šä»£å¸æ”¯æŒ**ï¼šæ‰€æœ‰ç¼“å­˜ä½¿ç”¨ tokenAddress ä½œä¸ºé”®ï¼Œæ”¯æŒå¤šä»£å¸å¹¶å­˜
3. **å¤šæ ‡ç­¾é¡µæ”¯æŒ**ï¼šä¸åŒä»£å¸ç‹¬ç«‹ç¼“å­˜ï¼Œåˆ‡æ¢æ ‡ç­¾é¡µæ— éœ€é‡æ–°æŸ¥è¯¢
4. **ä»£ç å¤ç”¨**ï¼šæœªè¿ç§»å’Œå·²è¿ç§»ä»£å¸ä½¿ç”¨ç»Ÿä¸€çš„å¤„ç†é€»è¾‘
5. **é¡µé¢åˆ‡æ¢é¢„åŠ è½½**ï¼šURL å˜åŒ–æ—¶åå°é¢„åŠ è½½æ‰€æœ‰ä¿¡æ¯
6. **å‰åç«¯è”åŠ¨**ï¼šå–å‡ºæ—¶ä½¿ç”¨å‰ç«¯ä½™é¢ï¼Œå‡å°‘ RPC æŸ¥è¯¢
7. **å¹¶å‘æŸ¥è¯¢ä¼˜åŒ–**ï¼šå¯å¹¶å‘çš„æŸ¥è¯¢å…¨éƒ¨å¹¶å‘æ‰§è¡Œ

**å…³é”®è°ƒæ•´**ï¼ˆåŸºäºç”¨æˆ·åé¦ˆï¼‰ï¼š
1. âœ… æœªè¿ç§»ä»£å¸æ”¹ä¸ºæ°¸ä¹…ç¼“å­˜ï¼ˆåŸè®¡åˆ’ 1 å°æ—¶ TTLï¼‰
2. âœ… æ‰€æœ‰ç¼“å­˜é”®åŒ…å«ä»£å¸åœ°å€ï¼Œæ”¯æŒå¤šä»£å¸
3. âœ… æ”¯æŒå¤šæ ‡ç­¾é¡µåŒæ—¶æ‰“å¼€ä¸åŒä»£å¸
4. âœ… ç»Ÿä¸€æœªè¿ç§»å’Œå·²è¿ç§»çš„å¤„ç†é€»è¾‘

---

## ğŸ¯ ä¼˜åŒ–ä»»åŠ¡æ¸…å•

### é˜¶æ®µ 1ï¼šè·¯ç”±ä¿¡æ¯æ°¸ä¹…ç¼“å­˜ä¼˜åŒ–

#### ä»»åŠ¡ 1.1ï¼šä¿®æ”¹è·¯ç”±ç¼“å­˜ç­–ç•¥
**æ–‡ä»¶**ï¼š`src/shared/token-route.ts`

**å½“å‰é—®é¢˜**ï¼š
- è·¯ç”±ä¿¡æ¯ç¼“å­˜ TTL ä¸º 10 åˆ†é’Ÿ
- è¿ç§»çŠ¶æ€å˜åŒ–åä»ä½¿ç”¨æ—§ç¼“å­˜

**ä¼˜åŒ–æ–¹æ¡ˆ**ï¼š
```typescript
// ç¼“å­˜ç»“æ„è°ƒæ•´ - æ”¯æŒå¤šä»£å¸ç¼“å­˜
type RouteCache = {
  route: RouteFetchResult;
  timestamp: number;
  migrationStatus: 'not_migrated' | 'migrated';  // è®°å½•è¿ç§»çŠ¶æ€
};

// ä½¿ç”¨ tokenAddress ä½œä¸ºé”®ï¼Œæ”¯æŒå¤šä»£å¸å¹¶å­˜
const routeCache = new Map<string, RouteCache>();

// ç¼“å­˜ç­–ç•¥ - ç»Ÿä¸€å¤„ç†æœªè¿ç§»å’Œå·²è¿ç§»
function shouldUpdateRouteCache(
  tokenAddress: string,
  cachedRoute: RouteCache | undefined,
  currentRoute: RouteFetchResult
): boolean {
  // 1. æ— ç¼“å­˜ â†’ æ›´æ–°
  if (!cachedRoute) return true;

  // 2. è¿ç§»çŠ¶æ€å˜åŒ– â†’ æ›´æ–°
  const cachedMigrated = cachedRoute.migrationStatus === 'migrated';
  const currentMigrated = currentRoute.readyForPancake;
  if (cachedMigrated !== currentMigrated) return true;

  // 3. è¿ç§»çŠ¶æ€æœªå˜åŒ– â†’ ä¸æ›´æ–°ï¼ˆæ°¸ä¹…ç¼“å­˜ï¼‰
  // æ³¨æ„ï¼šæœªè¿ç§»å’Œå·²è¿ç§»éƒ½ä½¿ç”¨æ°¸ä¹…ç¼“å­˜
  return false;
}

// è·å–ç¼“å­˜
function getRouteCache(tokenAddress: string): RouteCache | undefined {
  const normalized = tokenAddress.toLowerCase();
  return routeCache.get(normalized);
}

// è®¾ç½®ç¼“å­˜
function setRouteCache(tokenAddress: string, route: RouteFetchResult): void {
  const normalized = tokenAddress.toLowerCase();
  routeCache.set(normalized, {
    route,
    timestamp: Date.now(),
    migrationStatus: route.readyForPancake ? 'migrated' : 'not_migrated'
  });
}
```

**å®æ–½æ­¥éª¤**ï¼š
1. [ ] ä¿®æ”¹ `RouteCache` ç±»å‹å®šä¹‰ï¼Œæ·»åŠ  `migrationStatus` å­—æ®µ
2. [ ] å®ç°ç¼“å­˜é”®ç®¡ç†å‡½æ•°ï¼ˆ`getRouteCache`, `setRouteCache`ï¼‰
3. [ ] å®ç° `shouldUpdateRouteCache()` åˆ¤æ–­é€»è¾‘ï¼ˆç»Ÿä¸€å¤„ç†æœªè¿ç§»å’Œå·²è¿ç§»ï¼‰
4. [ ] ä¿®æ”¹ `fetchRouteWithFallback()` ä½¿ç”¨æ–°çš„ç¼“å­˜ç­–ç•¥
5. [ ] åˆ é™¤ `PAIR_CACHE_TTL` å¸¸é‡ï¼Œæ”¹ä¸ºæ°¸ä¹…ç¼“å­˜
6. [ ] æ·»åŠ æ‰‹åŠ¨æ¸…é™¤ç¼“å­˜çš„æ¥å£ï¼ˆç”¨äºè°ƒè¯•ï¼‰
7. [ ] ç¡®ä¿ç¼“å­˜é”®åŒ…å«ä»£å¸åœ°å€ï¼Œæ”¯æŒå¤šä»£å¸å¹¶å­˜

**é¢„æœŸæ•ˆæœ**ï¼š
- æœªè¿ç§»ä»£å¸ï¼šæ°¸ä¹…ç¼“å­˜ï¼Œåªåœ¨è¿ç§»æ—¶æ›´æ–°ï¼Œ0ms æŸ¥è¯¢æ—¶é—´
- å·²è¿ç§»ä»£å¸ï¼šæ°¸ä¹…ç¼“å­˜ï¼Œ0ms æŸ¥è¯¢æ—¶é—´
- å¤šä»£å¸æ”¯æŒï¼šåˆ‡æ¢ä»£å¸æ—¶ç›´æ¥ä½¿ç”¨ç¼“å­˜ï¼Œæ— éœ€é‡æ–°æŸ¥è¯¢
- å¤šæ ‡ç­¾é¡µæ”¯æŒï¼šæ¯ä¸ªä»£å¸ç‹¬ç«‹ç¼“å­˜ï¼Œåˆ‡æ¢ tab æ— éœ€é‡æ–°æŸ¥è¯¢

---

### é˜¶æ®µ 2ï¼šé¡µé¢åˆ‡æ¢æ—¶é¢„åŠ è½½ä¼˜åŒ–

#### ä»»åŠ¡ 2.1ï¼šContent Script æ£€æµ‹é¡µé¢åˆ‡æ¢
**æ–‡ä»¶**ï¼š`src/content/index.ts`

**å®æ–½æ­¥éª¤**ï¼š
1. [ ] åœ¨ URL å˜åŒ–ç›‘å¬å™¨ä¸­æ·»åŠ é¢„åŠ è½½é€»è¾‘
2. [ ] æå–ä»£å¸åœ°å€åç«‹å³è§¦å‘é¢„åŠ è½½
3. [ ] é¢„åŠ è½½å†…å®¹ï¼š
   - è·¯ç”±ä¿¡æ¯ï¼ˆå¦‚æœéœ€è¦æ›´æ–°ï¼‰
   - ä»£å¸ä½™é¢
   - Quote token ä½™é¢ï¼ˆå¦‚æœæ˜¯é BNB ç­¹é›†ï¼‰
   - æˆæƒçŠ¶æ€ï¼ˆå¦‚æœå¯ç”¨äº†åˆ‡æ¢é¡µé¢æˆæƒï¼‰

```typescript
// ä¼ªä»£ç 
async function onTokenPageChange(tokenAddress: string) {
  // å¹¶å‘é¢„åŠ è½½æ‰€æœ‰ä¿¡æ¯
  await Promise.all([
    // 1. é¢„åŠ è½½è·¯ç”±ä¿¡æ¯
    chrome.runtime.sendMessage({
      action: 'prefetch_token_route',
      data: { tokenAddress }
    }),

    // 2. é¢„åŠ è½½ä½™é¢
    chrome.runtime.sendMessage({
      action: 'prefetch_token_balance',
      data: { tokenAddress }
    }),

    // 3. å¦‚æœå¯ç”¨äº†åˆ‡æ¢é¡µé¢æˆæƒï¼Œæ‰§è¡Œæˆæƒ
    shouldAutoApproveOnSwitch() && chrome.runtime.sendMessage({
      action: 'auto_approve_on_switch',
      data: { tokenAddress }
    })
  ]);
}
```

**é¢„æœŸæ•ˆæœ**ï¼š
- ç”¨æˆ·ç‚¹å‡»ä¹°å…¥æ—¶ï¼Œæ‰€æœ‰ä¿¡æ¯å·²ç¼“å­˜
- èŠ‚çœ 800-1500ms

#### ä»»åŠ¡ 2.2ï¼šBackground å®ç°é¢„åŠ è½½æ¥å£
**æ–‡ä»¶**ï¼š`src/background/index.ts`

**å®æ–½æ­¥éª¤**ï¼š
1. [ ] æ·»åŠ  `prefetch_token_route` action å¤„ç†å™¨
2. [ ] æ·»åŠ  `prefetch_token_balance` action å¤„ç†å™¨
3. [ ] æ·»åŠ  `auto_approve_on_switch` action å¤„ç†å™¨
4. [ ] é¢„åŠ è½½å¤±è´¥ä¸å½±å“ä¸»æµç¨‹ï¼ˆé™é»˜å¤±è´¥ï¼‰
5. [ ] **æ”¯æŒå¤šä»£å¸ç¼“å­˜**ï¼šä½¿ç”¨ tokenAddress ä½œä¸ºç¼“å­˜é”®
6. [ ] **æ”¯æŒå¤šæ ‡ç­¾é¡µ**ï¼šæ¯ä¸ªä»£å¸ç‹¬ç«‹ç¼“å­˜ï¼Œä¸äº’ç›¸è¦†ç›–

```typescript
// å¤šä»£å¸ä½™é¢ç¼“å­˜
const tokenBalanceCache = new Map<string, {
  balance: string;
  timestamp: number;
}>();

async function handlePrefetchTokenRoute({ tokenAddress }) {
  try {
    const platform = detectTokenPlatform(tokenAddress);

    // æ£€æŸ¥ç¼“å­˜ï¼Œå¦‚æœå·²æœ‰ä¸”ä¸éœ€è¦æ›´æ–°ï¼Œç›´æ¥è¿”å›
    const cached = getRouteCache(tokenAddress);
    if (cached && !shouldUpdateRouteCache(tokenAddress, cached, null)) {
      logger.debug('[Prefetch] Route cache hit:', tokenAddress);
      return { success: true, cached: true };
    }

    // æŸ¥è¯¢å¹¶ç¼“å­˜
    const route = await fetchRouteWithFallback(
      publicClient,
      tokenAddress,
      platform
    );
    // ç»“æœå·²è‡ªåŠ¨ç¼“å­˜ï¼ˆä½¿ç”¨ tokenAddress ä½œä¸ºé”®ï¼‰
    return { success: true, cached: false };
  } catch (error) {
    // é™é»˜å¤±è´¥ï¼Œä¸å½±å“ç”¨æˆ·ä½“éªŒ
    logger.debug('[Prefetch] Route prefetch failed:', error);
    return { success: false };
  }
}

async function handlePrefetchTokenBalance({ tokenAddress }) {
  try {
    const normalized = tokenAddress.toLowerCase();

    // å¹¶å‘é¢„åŠ è½½ä»£å¸ä½™é¢å’Œ quote token ä½™é¢
    await Promise.all([
      // 1. ä»£å¸ä½™é¢
      (async () => {
        const balance = await fetchWalletBalances(
          walletAccount.address,
          tokenAddress
        );
        // ç¼“å­˜ä½™é¢ï¼ˆä½¿ç”¨ tokenAddress ä½œä¸ºé”®ï¼‰
        tokenBalanceCache.set(normalized, {
          balance: balance.tokenBalance || '0',
          timestamp: Date.now()
        });
      })(),

      // 2. Quote token ä½™é¢ï¼ˆå¦‚æœéœ€è¦ï¼‰
      (async () => {
        const route = getRouteCache(tokenAddress);
        if (route?.route?.quoteToken && !isBnbQuote(route.route.quoteToken)) {
          await getQuoteBalance(
            route.route.quoteToken,
            walletAccount.address
          );
        }
      })()
    ]);

    return { success: true };
  } catch (error) {
    logger.debug('[Prefetch] Balance prefetch failed:', error);
    return { success: false };
  }
}
```

**å¤šæ ‡ç­¾é¡µæ”¯æŒè¯´æ˜**ï¼š
- æ‰€æœ‰ç¼“å­˜ä½¿ç”¨ `tokenAddress` ä½œä¸ºé”®
- ä¸åŒä»£å¸çš„æ•°æ®ç‹¬ç«‹å­˜å‚¨
- åˆ‡æ¢æ ‡ç­¾é¡µæ—¶ï¼Œå¦‚æœè¯¥ä»£å¸å·²ç¼“å­˜ï¼Œç›´æ¥ä½¿ç”¨
- å¤šä¸ªæ ‡ç­¾é¡µå¯ä»¥åŒæ—¶æ‰“å¼€ä¸åŒä»£å¸ï¼Œäº’ä¸å¹²æ‰°

---

### é˜¶æ®µ 3ï¼šä½™é¢ç¼“å­˜ç­–ç•¥ä¼˜åŒ–

#### ä»»åŠ¡ 3.0ï¼šå¤šä»£å¸å’Œå¤šæ ‡ç­¾é¡µæ¶æ„è®¾è®¡

**è®¾è®¡åŸåˆ™**ï¼š
1. **æ‰€æœ‰ç¼“å­˜ä½¿ç”¨ tokenAddress ä½œä¸ºé”®**
2. **æ”¯æŒå¤šä»£å¸å¹¶å­˜**ï¼šä¸åŒä»£å¸çš„æ•°æ®ç‹¬ç«‹å­˜å‚¨
3. **æ”¯æŒå¤šæ ‡ç­¾é¡µ**ï¼šå¤šä¸ªæ ‡ç­¾é¡µå¯ä»¥åŒæ—¶æ‰“å¼€ä¸åŒä»£å¸
4. **ç»Ÿä¸€çš„ç¼“å­˜ç®¡ç†**ï¼šæœªè¿ç§»å’Œå·²è¿ç§»ä»£å¸ä½¿ç”¨ç›¸åŒçš„ç¼“å­˜é€»è¾‘

**ç¼“å­˜é”®è®¾è®¡**ï¼š
```typescript
// è·¯ç”±ç¼“å­˜é”®ï¼štokenAddress
const routeCacheKey = tokenAddress.toLowerCase();

// ä½™é¢ç¼“å­˜é”®ï¼štokenAddress
const balanceCacheKey = tokenAddress.toLowerCase();

// Quote token ä½™é¢ç¼“å­˜é”®ï¼šquoteTokenAddress-walletAddress
const quoteCacheKey = `${quoteToken.toLowerCase()}-${wallet.toLowerCase()}`;

// æˆæƒç¼“å­˜é”®ï¼štokenAddress-spenderAddress
const approvalCacheKey = `${token.toLowerCase()}-${spender.toLowerCase()}`;
```

**å¤šæ ‡ç­¾é¡µåœºæ™¯ç¤ºä¾‹**ï¼š
```
Tab 1: ä»£å¸ A (0xAAA...)
  - routeCache.get('0xaaa...') â†’ ä»£å¸ A çš„è·¯ç”±ä¿¡æ¯
  - balanceCache.get('0xaaa...') â†’ ä»£å¸ A çš„ä½™é¢

Tab 2: ä»£å¸ B (0xBBB...)
  - routeCache.get('0xbbb...') â†’ ä»£å¸ B çš„è·¯ç”±ä¿¡æ¯
  - balanceCache.get('0xbbb...') â†’ ä»£å¸ B çš„ä½™é¢

åˆ‡æ¢ Tab 1 â†’ Tab 2ï¼š
  - ç›´æ¥ä½¿ç”¨ç¼“å­˜ï¼Œæ— éœ€é‡æ–°æŸ¥è¯¢
  - å¦‚æœç¼“å­˜ä¸å­˜åœ¨ï¼Œè§¦å‘é¢„åŠ è½½

åˆ‡æ¢ Tab 2 â†’ Tab 1ï¼š
  - ç›´æ¥ä½¿ç”¨ç¼“å­˜ï¼Œæ— éœ€é‡æ–°æŸ¥è¯¢
```

**å®æ–½æ­¥éª¤**ï¼š
1. [ ] è®¾è®¡ç»Ÿä¸€çš„ç¼“å­˜é”®ç”Ÿæˆå‡½æ•°
2. [ ] ç¡®ä¿æ‰€æœ‰ç¼“å­˜æ“ä½œä½¿ç”¨æ ‡å‡†åŒ–çš„é”®
3. [ ] å®ç°ç¼“å­˜æ¸…ç†ç­–ç•¥ï¼ˆé¿å…å†…å­˜æ³„æ¼ï¼‰
4. [ ] æ·»åŠ ç¼“å­˜ç»Ÿè®¡å’Œç›‘æ§

**ç¼“å­˜æ¸…ç†ç­–ç•¥**ï¼š
```typescript
// é™åˆ¶ç¼“å­˜æ•°é‡ï¼Œé¿å…å†…å­˜æ³„æ¼
const MAX_CACHE_SIZE = 50; // æœ€å¤šç¼“å­˜ 50 ä¸ªä»£å¸

function cleanupCache<T>(cache: Map<string, T>) {
  if (cache.size > MAX_CACHE_SIZE) {
    // åˆ é™¤æœ€æ—§çš„ç¼“å­˜é¡¹
    const entries = Array.from(cache.entries());
    entries.sort((a, b) => {
      const aTime = (a[1] as any).timestamp || 0;
      const bTime = (b[1] as any).timestamp || 0;
      return aTime - bTime;
    });

    // åˆ é™¤æœ€æ—§çš„ 10 ä¸ª
    for (let i = 0; i < 10; i++) {
      cache.delete(entries[i][0]);
    }
  }
}
```

---

### é˜¶æ®µ 4ï¼šä½™é¢æ›´æ–°ç­–ç•¥å®æ–½

#### ä»»åŠ¡ 3.1ï¼šå®ç°æ™ºèƒ½ä½™é¢æ›´æ–°ç­–ç•¥
**æ–‡ä»¶**ï¼š`src/content/index.ts`

**å½“å‰é—®é¢˜**ï¼š
- ä½™é¢æ¯ 10 ç§’è½®è¯¢æ›´æ–°
- äº¤æ˜“åä¹Ÿæ˜¯ç­‰å¾…è½®è¯¢æ›´æ–°

**ä¼˜åŒ–æ–¹æ¡ˆ**ï¼š
```typescript
// ä½™é¢æ›´æ–°ç­–ç•¥
const balanceUpdateStrategy = {
  // 1. åˆ‡æ¢åˆ°ä»£å¸é¡µé¢ï¼šç«‹å³æ›´æ–°
  onPageSwitch: () => updateBalance({ immediate: true }),

  // 2. æ­£å¸¸è½®è¯¢ï¼š15 ç§’é—´éš”
  pollingInterval: 15000,

  // 3. äº¤æ˜“åï¼šç«‹å³æ›´æ–°
  onTradeComplete: () => updateBalance({ immediate: true }),

  // 4. ç”¨æˆ·ä¸»åŠ¨åˆ·æ–°ï¼šç«‹å³æ›´æ–°
  onUserRefresh: () => updateBalance({ immediate: true })
};
```

**å®æ–½æ­¥éª¤**ï¼š
1. [ ] ä¿®æ”¹ `CONTENT_CONFIG.BALANCE_UPDATE_INTERVAL` ä¸º 15000ms
2. [ ] åœ¨é¡µé¢åˆ‡æ¢æ—¶è§¦å‘ç«‹å³æ›´æ–°
3. [ ] åœ¨äº¤æ˜“å®Œæˆå›è°ƒä¸­è§¦å‘ç«‹å³æ›´æ–°
4. [ ] æ·»åŠ æ‰‹åŠ¨åˆ·æ–°æŒ‰é’®ï¼ˆå¯é€‰ï¼‰

**é¢„æœŸæ•ˆæœ**ï¼š
- å‡å°‘ 40% ä½™é¢æŸ¥è¯¢æ¬¡æ•°
- äº¤æ˜“åç«‹å³çœ‹åˆ°æœ€æ–°ä½™é¢

#### ä»»åŠ¡ 3.2ï¼šå–å‡ºæ—¶æœ¬åœ°è®¡ç®—ä½™é¢
**æ–‡ä»¶**ï¼š`src/content/index.ts`

**å½“å‰é—®é¢˜**ï¼š
- å–å‡ºä¼°ç®—æ—¶æŸ¥è¯¢é“¾ä¸Šä½™é¢

**ä¼˜åŒ–æ–¹æ¡ˆ**ï¼š
```typescript
// å–å‡ºæ—¶ä½¿ç”¨å‰ç«¯ç¼“å­˜çš„ä½™é¢
async function handleSellPercentChange(percent: number) {
  // ä»å‰ç«¯çŠ¶æ€è·å–ä½™é¢ï¼Œä¸æŸ¥è¯¢é“¾ä¸Š
  const cachedBalance = getCurrentTokenBalance();
  const sellAmount = (cachedBalance * percent) / 100;

  // ä½¿ç”¨æœ¬åœ°è®¡ç®—çš„æ•°é‡è¿›è¡Œä¼°ç®—
  await estimateSellAmount(sellAmount);
}
```

**å®æ–½æ­¥éª¤**ï¼š
1. [ ] ä¿®æ”¹å–å‡ºç™¾åˆ†æ¯”è¾“å…¥å¤„ç†é€»è¾‘
2. [ ] ä½¿ç”¨å‰ç«¯ç¼“å­˜çš„ä½™é¢è®¡ç®—å–å‡ºæ•°é‡
3. [ ] åªåœ¨ä¼°ç®—æ—¶æŸ¥è¯¢ä»·æ ¼ï¼Œä¸æŸ¥è¯¢ä½™é¢
4. [ ] å‰ç«¯ä¼ é€’å®é™…æ•°é‡åˆ° background

**é¢„æœŸæ•ˆæœ**ï¼š
- å–å‡ºæ“ä½œå‡å°‘ 1 æ¬¡ä½™é¢æŸ¥è¯¢
- èŠ‚çœ 200-300ms

---

### é˜¶æ®µ 5ï¼šå¹¶å‘æŸ¥è¯¢ä¼˜åŒ–

#### ä»»åŠ¡ 5.1ï¼šFour Quote Bridge å¹¶å‘ä¼˜åŒ–
**æ–‡ä»¶**ï¼š`src/background/four-quote-bridge.ts`

**è®¾è®¡åŸåˆ™**ï¼š
- **ä»£ç å¤ç”¨**ï¼šæœªè¿ç§»å’Œå·²è¿ç§»ä»£å¸ä½¿ç”¨ç›¸åŒçš„æŸ¥è¯¢é€»è¾‘
- **ç»Ÿä¸€æ¥å£**ï¼šæä¾›ç»Ÿä¸€çš„æŸ¥è¯¢æ¥å£ï¼Œå†…éƒ¨æ ¹æ®è¿ç§»çŠ¶æ€é€‰æ‹©ä¸åŒçš„å®ç°

**å½“å‰é—®é¢˜**ï¼š
```typescript
// ä¸²è¡ŒæŸ¥è¯¢
const quoteBalance = await getQuoteBalance(...);
const allowance = await readContract({ functionName: 'allowance' });
const amountIn = await estimateQuoteToBnbAmount(...);
```

**ä¼˜åŒ–æ–¹æ¡ˆ**ï¼š
```typescript
// å¹¶å‘æŸ¥è¯¢
const [quoteBalance, allowance, amountIn] = await Promise.all([
  getQuoteBalance(...),
  readContract({ functionName: 'allowance' }),
  estimateQuoteToBnbAmount(...)
]);
```

**å®æ–½æ­¥éª¤**ï¼š
1. [ ] è¯†åˆ« `prepareFourQuoteBuy()` ä¸­æ‰€æœ‰å¯å¹¶å‘çš„æŸ¥è¯¢
2. [ ] ä½¿ç”¨ `Promise.all()` æ”¹å†™
3. [ ] ç¡®ä¿é”™è¯¯å¤„ç†æ­£ç¡®
4. [ ] æ·»åŠ æ€§èƒ½æ—¥å¿—
5. [ ] **ç¡®ä¿ä»£ç å¤ç”¨**ï¼šæœªè¿ç§»å’Œå·²è¿ç§»ä»£å¸ä½¿ç”¨ç›¸åŒçš„å¹¶å‘æŸ¥è¯¢é€»è¾‘

**ä»£ç å¤ç”¨ç¤ºä¾‹**ï¼š
```typescript
// ç»Ÿä¸€çš„æŸ¥è¯¢æ¥å£ï¼Œæ”¯æŒæœªè¿ç§»å’Œå·²è¿ç§»
async function prepareTokenBuy(params: {
  tokenAddress: string;
  amount: string;
  route: RouteFetchResult;
}) {
  const { tokenAddress, amount, route } = params;

  // æ ¹æ®è¿ç§»çŠ¶æ€é€‰æ‹©ä¸åŒçš„å®ç°ï¼Œä½†ä½¿ç”¨ç›¸åŒçš„å¹¶å‘æ¨¡å¼
  if (route.readyForPancake) {
    // å·²è¿ç§»ï¼šä½¿ç”¨ Pancake
    return preparePancakeBuy({ tokenAddress, amount, route });
  } else {
    // æœªè¿ç§»ï¼šä½¿ç”¨å¹³å°åˆçº¦
    return preparePlatformBuy({ tokenAddress, amount, route });
  }
}

// ä¸¤ç§å®ç°éƒ½ä½¿ç”¨å¹¶å‘æŸ¥è¯¢
async function preparePlatformBuy(params) {
  const [balance, allowance, price] = await Promise.all([
    getQuoteBalance(...),
    checkAllowance(...),
    estimatePrice(...)
  ]);
  // ...
}

async function preparePancakeBuy(params) {
  const [balance, allowance, price] = await Promise.all([
    getTokenBalance(...),
    checkAllowance(...),
    estimatePrice(...)
  ]);
  // ...
}
```

**é¢„æœŸæ•ˆæœ**ï¼š
- èŠ‚çœ 200-400ms

#### ä»»åŠ¡ 4.2ï¼šFlap Quote Bridge å¹¶å‘ä¼˜åŒ–
**æ–‡ä»¶**ï¼š`src/background/flap-quote-agent.ts`

**å®æ–½æ­¥éª¤**ï¼š
1. [ ] è¯†åˆ« `prepareFlapQuoteBuy()` ä¸­å¯å¹¶å‘çš„æŸ¥è¯¢
2. [ ] ä½¿ç”¨ `Promise.all()` æ”¹å†™
3. [ ] æµ‹è¯•éªŒè¯

**é¢„æœŸæ•ˆæœ**ï¼š
- èŠ‚çœ 200-400ms

---

### é˜¶æ®µ 6ï¼šä»£å¸ä¿¡æ¯ç¼“å­˜ä¼˜åŒ–

#### ä»»åŠ¡ 6.1ï¼šè°ƒæŸ¥ç°æœ‰ä»£å¸ä¿¡æ¯ç¼“å­˜
**æ–‡ä»¶**ï¼šéœ€è¦è°ƒæŸ¥

**è°ƒæŸ¥å†…å®¹**ï¼š
1. [ ] æŸ¥æ‰¾ä»£å¸ä¿¡æ¯ç¼“å­˜çš„å®ç°ä½ç½®
2. [ ] äº†è§£ç¼“å­˜çš„æ•°æ®ç»“æ„å’Œ TTL
3. [ ] åˆ†ææ˜¯å¦å¯ä»¥ä¼˜åŒ–

**è°ƒæŸ¥é—®é¢˜**ï¼š
- ä»£å¸ä¿¡æ¯åŒ…å«å“ªäº›å­—æ®µï¼Ÿï¼ˆname, symbol, decimals, logo ç­‰ï¼‰
- ç¼“å­˜åœ¨å“ªé‡Œï¼Ÿï¼ˆlocalStorage, chrome.storage, å†…å­˜ï¼‰
- TTL æ˜¯å¤šå°‘ï¼Ÿ
- æ˜¯å¦åœ¨é¡µé¢åˆ‡æ¢æ—¶é¢„åŠ è½½ï¼Ÿ

#### ä»»åŠ¡ 6.2ï¼šä¼˜åŒ–ä»£å¸ä¿¡æ¯ç¼“å­˜ç­–ç•¥
**æ ¹æ®è°ƒæŸ¥ç»“æœåˆ¶å®š**

**å¯èƒ½çš„ä¼˜åŒ–æ–¹å‘**ï¼š
1. æ°¸ä¹…ç¼“å­˜åŸºæœ¬ä¿¡æ¯ï¼ˆname, symbol, decimalsï¼‰
2. é¡µé¢åˆ‡æ¢æ—¶é¢„åŠ è½½
3. ä¸è·¯ç”±ä¿¡æ¯ä¸€èµ·ç¼“å­˜

---

### é˜¶æ®µ 7ï¼šæˆæƒç­–ç•¥éªŒè¯å’Œä¼˜åŒ–

#### ä»»åŠ¡ 7.1ï¼šéªŒè¯ç°æœ‰æˆæƒç­–ç•¥
**æ–‡ä»¶**ï¼šéœ€è¦è°ƒæŸ¥

**éªŒè¯å†…å®¹**ï¼š
1. [ ] ç¡®è®¤ä¸‰ç§æˆæƒæ¨¡å¼çš„å®ç°ä½ç½®
2. [ ] æµ‹è¯•æ¯ç§æ¨¡å¼çš„æ•ˆæœ
3. [ ] ç¡®è®¤æ˜¯å¦å·²è§£å†³æˆæƒæ—¶å»¶é—®é¢˜

**ä¸‰ç§æ¨¡å¼**ï¼š
- åˆ‡æ¢åˆ°äº¤æ˜“é¡µé¢æˆæƒ
- ä¹°å…¥åæˆæƒ
- å–å‡ºæ—¶å…ˆæˆæƒ

#### ä»»åŠ¡ 7.2ï¼šæˆæƒç¼“å­˜ä¼˜åŒ–ï¼ˆå¦‚æœéœ€è¦ï¼‰
**æ–‡ä»¶**ï¼š`src/background/index.ts` æˆ–ç›¸å…³æ–‡ä»¶

**ä¼˜åŒ–æ–¹æ¡ˆ**ï¼š
```typescript
// æœ¬åœ°æˆæƒçŠ¶æ€ç¼“å­˜
const approvalStatusCache = new Map<string, {
  approved: boolean;
  timestamp: number;
  amount: bigint;
}>();

async function checkApprovalStatus(token, spender) {
  const cacheKey = `${token}-${spender}`;
  const cached = approvalStatusCache.get(cacheKey);

  // å¦‚æœæœ¬åœ°ç¼“å­˜æ˜¾ç¤ºå·²æˆæƒï¼Œç›´æ¥è¿”å›
  if (cached?.approved) {
    return { approved: true, amount: cached.amount };
  }

  // æŸ¥è¯¢é“¾ä¸ŠçŠ¶æ€
  const allowance = await readContract({...});
  const approved = allowance >= REQUIRED_AMOUNT;

  // æ›´æ–°ç¼“å­˜
  approvalStatusCache.set(cacheKey, {
    approved,
    timestamp: Date.now(),
    amount: allowance
  });

  return { approved, amount: allowance };
}
```

**å®æ–½æ­¥éª¤**ï¼š
1. [ ] å®ç°æœ¬åœ°æˆæƒçŠ¶æ€ç¼“å­˜
2. [ ] æˆæƒæˆåŠŸåæ›´æ–°ç¼“å­˜
3. [ ] äº¤æ˜“å¤±è´¥æ—¶æ¸…é™¤ç¼“å­˜
4. [ ] æ·»åŠ æ‰‹åŠ¨æ¸…é™¤ç¼“å­˜æ¥å£

---

## ğŸ“… å¼€å‘æ—¶é—´è¡¨

### ç¬¬ 1 å‘¨ï¼šæ ¸å¿ƒä¼˜åŒ–

**Day 1-2ï¼šè·¯ç”±ä¿¡æ¯æ°¸ä¹…ç¼“å­˜**
- ä»»åŠ¡ 1.1ï¼šä¿®æ”¹è·¯ç”±ç¼“å­˜ç­–ç•¥
- æµ‹è¯•éªŒè¯

**Day 3-4ï¼šé¡µé¢åˆ‡æ¢é¢„åŠ è½½**
- ä»»åŠ¡ 2.1ï¼šContent Script æ£€æµ‹é¡µé¢åˆ‡æ¢
- ä»»åŠ¡ 2.2ï¼šBackground å®ç°é¢„åŠ è½½æ¥å£
- æµ‹è¯•éªŒè¯

**Day 5ï¼šä½™é¢ç¼“å­˜ä¼˜åŒ–**
- ä»»åŠ¡ 3.1ï¼šå®ç°æ™ºèƒ½ä½™é¢æ›´æ–°ç­–ç•¥
- ä»»åŠ¡ 3.2ï¼šå–å‡ºæ—¶æœ¬åœ°è®¡ç®—ä½™é¢
- æµ‹è¯•éªŒè¯

### ç¬¬ 2 å‘¨ï¼šå¹¶å‘ä¼˜åŒ–å’Œè°ƒæŸ¥

**Day 1-2ï¼šå¹¶å‘æŸ¥è¯¢ä¼˜åŒ–**
- ä»»åŠ¡ 4.1ï¼šFour Quote Bridge å¹¶å‘ä¼˜åŒ–
- ä»»åŠ¡ 4.2ï¼šFlap Quote Bridge å¹¶å‘ä¼˜åŒ–
- æµ‹è¯•éªŒè¯

**Day 3-4ï¼šä»£å¸ä¿¡æ¯å’Œæˆæƒè°ƒæŸ¥**
- ä»»åŠ¡ 6.1ï¼šè°ƒæŸ¥ç°æœ‰ä»£å¸ä¿¡æ¯ç¼“å­˜
- ä»»åŠ¡ 7.1ï¼šéªŒè¯ç°æœ‰æˆæƒç­–ç•¥
- æ ¹æ®è°ƒæŸ¥ç»“æœåˆ¶å®šä¼˜åŒ–æ–¹æ¡ˆ

**Day 5ï¼šè¡¥å……ä¼˜åŒ–**
- ä»»åŠ¡ 6.2ï¼šä¼˜åŒ–ä»£å¸ä¿¡æ¯ç¼“å­˜ç­–ç•¥ï¼ˆå¦‚æœéœ€è¦ï¼‰
- ä»»åŠ¡ 7.2ï¼šæˆæƒç¼“å­˜ä¼˜åŒ–ï¼ˆå¦‚æœéœ€è¦ï¼‰
- æ•´ä½“æµ‹è¯•

---

## ğŸ¯ æ€§èƒ½ç›®æ ‡

### ä¼˜åŒ–å‰ï¼ˆå½“å‰ï¼‰

| åœºæ™¯ | é¦–æ¬¡äº¤æ˜“ | ç¬¬äºŒæ¬¡äº¤æ˜“ |
|------|---------|-----------|
| æœªæˆæƒ | 3600-6300ms | 800-1600ms |
| å·²æˆæƒ | 1600-3300ms | 800-1600ms |

### ä¼˜åŒ–åï¼ˆç›®æ ‡ï¼‰

| åœºæ™¯ | é¦–æ¬¡äº¤æ˜“ | ç¬¬äºŒæ¬¡äº¤æ˜“ |
|------|---------|-----------|
| æœªæˆæƒï¼ˆåˆ‡æ¢é¡µé¢æˆæƒï¼‰ | 800-1200ms | 600-1000ms |
| å·²æˆæƒ | 600-1000ms | 600-1000ms |

**å…³é”®æŒ‡æ ‡**ï¼š
- âœ… é¦–æ¬¡äº¤æ˜“ï¼ˆå·²æˆæƒï¼‰ï¼š< 1000ms
- âœ… ç¬¬äºŒæ¬¡äº¤æ˜“ï¼š< 1000ms
- âœ… é¡µé¢åˆ‡æ¢åˆ°ç‚¹å‡»ä¹°å…¥ï¼šæ‰€æœ‰ä¿¡æ¯å·²é¢„åŠ è½½

---

## ğŸ§ª æµ‹è¯•è®¡åˆ’

### å•å…ƒæµ‹è¯•

1. [ ] è·¯ç”±ç¼“å­˜ç­–ç•¥æµ‹è¯•
   - æµ‹è¯•è¿ç§»çŠ¶æ€å˜åŒ–æ—¶çš„ç¼“å­˜æ›´æ–°
   - æµ‹è¯•å·²è¿ç§»ä»£å¸çš„æ°¸ä¹…ç¼“å­˜
   - æµ‹è¯•æœªè¿ç§»ä»£å¸çš„ TTL

2. [ ] é¢„åŠ è½½åŠŸèƒ½æµ‹è¯•
   - æµ‹è¯•é¡µé¢åˆ‡æ¢æ—¶çš„é¢„åŠ è½½è§¦å‘
   - æµ‹è¯•é¢„åŠ è½½å¤±è´¥çš„å®¹é”™
   - æµ‹è¯•å¹¶å‘é¢„åŠ è½½

3. [ ] ä½™é¢ç¼“å­˜æµ‹è¯•
   - æµ‹è¯• 15 ç§’è½®è¯¢
   - æµ‹è¯•äº¤æ˜“åç«‹å³æ›´æ–°
   - æµ‹è¯•æœ¬åœ°è®¡ç®—å–å‡ºæ•°é‡

### é›†æˆæµ‹è¯•

1. [ ] å®Œæ•´äº¤æ˜“æµç¨‹æµ‹è¯•
   - æµ‹è¯•é¦–æ¬¡äº¤æ˜“æ€§èƒ½
   - æµ‹è¯•ç¬¬äºŒæ¬¡äº¤æ˜“æ€§èƒ½
   - æµ‹è¯•ä¸åŒæˆæƒæ¨¡å¼

2. [ ] è¾¹ç•Œæƒ…å†µæµ‹è¯•
   - æµ‹è¯•ç½‘ç»œæ…¢çš„æƒ…å†µ
   - æµ‹è¯• RPC èŠ‚ç‚¹å¤±è´¥çš„æƒ…å†µ
   - æµ‹è¯•ç¼“å­˜å¤±æ•ˆçš„æƒ…å†µ

### æ€§èƒ½æµ‹è¯•

1. [ ] ä½¿ç”¨ Performance API è®°å½•æ¯ä¸ªæ­¥éª¤è€—æ—¶
2. [ ] å¯¹æ¯”ä¼˜åŒ–å‰åçš„æ€§èƒ½æ•°æ®
3. [ ] ç”Ÿæˆæ€§èƒ½æŠ¥å‘Š

---

## ğŸ“Š æˆåŠŸæ ‡å‡†

### å¿…é¡»è¾¾æˆï¼ˆP0ï¼‰

- [x] é¦–æ¬¡äº¤æ˜“ï¼ˆå·²æˆæƒï¼‰< 1000ms
- [x] ç¬¬äºŒæ¬¡äº¤æ˜“ < 1000ms
- [x] è·¯ç”±ä¿¡æ¯æ°¸ä¹…ç¼“å­˜ï¼ˆå·²è¿ç§»ä»£å¸ï¼‰
- [x] é¡µé¢åˆ‡æ¢æ—¶é¢„åŠ è½½æ‰€æœ‰ä¿¡æ¯

### åº”è¯¥è¾¾æˆï¼ˆP1ï¼‰

- [x] å¹¶å‘æŸ¥è¯¢ä¼˜åŒ–å®Œæˆ
- [x] ä½™é¢ç¼“å­˜ç­–ç•¥ä¼˜åŒ–å®Œæˆ
- [x] å–å‡ºæ—¶æœ¬åœ°è®¡ç®—ä½™é¢

### å¯ä»¥è¾¾æˆï¼ˆP2ï¼‰

- [ ] ä»£å¸ä¿¡æ¯ç¼“å­˜ä¼˜åŒ–
- [ ] æˆæƒçŠ¶æ€æœ¬åœ°ç¼“å­˜
- [ ] æ€§èƒ½ç›‘æ§é¢æ¿

---

## ğŸ”§ æŠ€æœ¯é£é™©å’Œç¼“è§£æªæ–½

### é£é™© 1ï¼šç¼“å­˜å¤±æ•ˆå¯¼è‡´æ•°æ®ä¸ä¸€è‡´

**é£é™©æè¿°**ï¼šæ°¸ä¹…ç¼“å­˜å¯èƒ½å¯¼è‡´è¿ç§»çŠ¶æ€å˜åŒ–åä»ä½¿ç”¨æ—§æ•°æ®

**ç¼“è§£æªæ–½**ï¼š
1. å®ç°æ™ºèƒ½ç¼“å­˜æ›´æ–°é€»è¾‘
2. æä¾›æ‰‹åŠ¨æ¸…é™¤ç¼“å­˜æ¥å£
3. äº¤æ˜“å¤±è´¥æ—¶è‡ªåŠ¨æ¸…é™¤ç›¸å…³ç¼“å­˜
4. æ·»åŠ ç¼“å­˜ç‰ˆæœ¬å·ï¼Œå‡çº§æ—¶è‡ªåŠ¨æ¸…é™¤æ—§ç¼“å­˜

### é£é™© 2ï¼šé¢„åŠ è½½å¤±è´¥å½±å“ç”¨æˆ·ä½“éªŒ

**é£é™©æè¿°**ï¼šé¢„åŠ è½½å¤±è´¥å¯èƒ½å¯¼è‡´äº¤æ˜“æ—¶ä»éœ€æŸ¥è¯¢

**ç¼“è§£æªæ–½**ï¼š
1. é¢„åŠ è½½å¤±è´¥é™é»˜å¤„ç†ï¼Œä¸å½±å“ä¸»æµç¨‹
2. äº¤æ˜“æ—¶æ£€æŸ¥ç¼“å­˜ï¼Œå¦‚æœæ²¡æœ‰åˆ™å®æ—¶æŸ¥è¯¢
3. æ·»åŠ é¢„åŠ è½½é‡è¯•æœºåˆ¶
4. æ·»åŠ é¢„åŠ è½½çŠ¶æ€ç›‘æ§

### é£é™© 3ï¼šå¹¶å‘æŸ¥è¯¢å¯¼è‡´ RPC èŠ‚ç‚¹é™æµ

**é£é™©æè¿°**ï¼šè¿‡å¤šå¹¶å‘æŸ¥è¯¢å¯èƒ½è§¦å‘èŠ‚ç‚¹é™æµ

**ç¼“è§£æªæ–½**ï¼š
1. æ§åˆ¶å¹¶å‘æ•°é‡ï¼ˆæœ€å¤š 3-5 ä¸ªå¹¶å‘ï¼‰
2. å®ç°è¯·æ±‚é˜Ÿåˆ—
3. æ·»åŠ é™æµæ£€æµ‹å’Œè‡ªåŠ¨é™çº§
4. ä½¿ç”¨å¤šä¸ªå¤‡ç”¨èŠ‚ç‚¹

---

## ğŸ“ éªŒæ”¶æ ‡å‡†

### ä»£ç è´¨é‡

- [ ] æ‰€æœ‰æ–°å¢ä»£ç æœ‰æ³¨é‡Š
- [ ] å…³é”®å‡½æ•°æœ‰æ€§èƒ½æ—¥å¿—
- [ ] é”™è¯¯å¤„ç†å®Œå–„
- [ ] ä»£ç é€šè¿‡ ESLint æ£€æŸ¥

### åŠŸèƒ½å®Œæ•´æ€§

- [ ] æ‰€æœ‰ä¼˜åŒ–ä»»åŠ¡å®Œæˆ
- [ ] æ‰€æœ‰æµ‹è¯•ç”¨ä¾‹é€šè¿‡
- [ ] æ€§èƒ½ç›®æ ‡è¾¾æˆ
- [ ] æ— æ–°å¢ bug

### æ–‡æ¡£å®Œæ•´æ€§

- [ ] æ›´æ–°æŠ€æœ¯æ–‡æ¡£
- [ ] æ›´æ–° CHANGELOG
- [ ] æ·»åŠ æ€§èƒ½ä¼˜åŒ–è¯´æ˜
- [ ] æ·»åŠ ç¼“å­˜ç­–ç•¥æ–‡æ¡£

---

## ğŸš€ å‘å¸ƒè®¡åˆ’

### ç‰ˆæœ¬å·ï¼šv1.1.5

### å‘å¸ƒå†…å®¹

**æ€§èƒ½ä¼˜åŒ–**ï¼š
- è·¯ç”±ä¿¡æ¯æ°¸ä¹…ç¼“å­˜ï¼ˆå·²è¿ç§»ä»£å¸ï¼‰
- é¡µé¢åˆ‡æ¢æ—¶é¢„åŠ è½½æ‰€æœ‰ä¿¡æ¯
- æ™ºèƒ½ä½™é¢æ›´æ–°ç­–ç•¥ï¼ˆ15ç§’è½®è¯¢ + äº¤æ˜“åç«‹å³æ›´æ–°ï¼‰
- å–å‡ºæ—¶æœ¬åœ°è®¡ç®—ä½™é¢
- å¹¶å‘æŸ¥è¯¢ä¼˜åŒ–

**æ•ˆæœ**ï¼š
- é¦–æ¬¡äº¤æ˜“é€Ÿåº¦æå‡ 60-70%ï¼ˆ3+ ç§’ â†’ < 1 ç§’ï¼‰
- å‡å°‘ 50% RPC è¯·æ±‚æ¬¡æ•°
- ç”¨æˆ·ä½“éªŒæ˜¾è‘—æå‡

---

**è®¡åˆ’åˆ¶å®šæ—¶é—´**ï¼š2026-01-26
**é¢„è®¡å®Œæˆæ—¶é—´**ï¼š2026-02-09ï¼ˆ2 å‘¨ï¼‰
**è´Ÿè´£äºº**ï¼šå¾…å®š
**ä¼˜å…ˆçº§**ï¼šP0ï¼ˆé«˜ä¼˜å…ˆçº§ï¼‰
